<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>popx coffee lab ‚Äî Beans Manager</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --color-navy: #243668;
            --color-pink: #ff9fb4;
            --color-cyan: #7af2e0;
            --color-bg: #fcfcfc;
            --color-text-primary: #4b3e3c;
            --color-text-secondary: #666;
            --color-card-bg: #ffffff;
            --color-border: #e8e8e8;

            --shadow-subtle: 0 4px 20px rgba(36, 54, 104, 0.08);
            --transition-smooth: 0.3s ease;

            --font-heading: 'Montserrat', sans-serif;
            --font-body: 'Noto Sans JP', sans-serif;
            --letter-spacing-body: 0.05em;
            --letter-spacing-heading: 0.1em;
            --radius-card: 16px;
            --radius-button: 100vh;
        }

        html, body {
            width: 100%;
            height: 100%;
            font-family: var(--font-body);
            background-color: var(--color-bg);
            color: var(--color-text-primary);
            line-height: 1.6;
            letter-spacing: 0.05em;
            font-feature-settings: "palt" 1;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* ===== HEADER ===== */
        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background-color: var(--color-card-bg);
            padding: 24px 0;
            box-shadow: 0 1px 2px rgba(36, 54, 104, 0.04);
            border-bottom: 1px solid rgba(36, 54, 104, 0.08);
        }

        body {
            padding-top: 90px;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-family: var(--font-body);
            font-size: 20px;
            font-weight: 600;
            letter-spacing: 0.05em;
            color: var(--color-text-primary);
            margin: 0;
        }

        .header-subtitle {
            font-family: var(--font-heading);
            font-size: 13px;
            font-weight: 400;
            color: var(--color-text-secondary);
            letter-spacing: 0.05em;
            margin: 0;
        }

        .header-back-link {
            font-family: var(--font-heading);
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.05em;
            color: var(--color-navy);
            text-decoration: none;
            transition: color var(--transition-smooth);
        }

        .header-back-link:hover {
            color: var(--color-text-primary);
        }

        /* ===== TAB NAVIGATION ===== */
        .tab-nav {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
            border-bottom: 1px solid rgba(36, 54, 104, 0.1);
            padding-bottom: 0;
        }

        .tab-button {
            padding: 12px 0;
            font-family: var(--font-heading);
            font-size: 15px;
            font-weight: 600;
            letter-spacing: 0.05em;
            border: none;
            background-color: transparent;
            color: var(--color-text-secondary);
            border-radius: 0;
            cursor: pointer;
            transition: all var(--transition-smooth);
            position: relative;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
        }

        .tab-button:hover {
            color: var(--color-text-primary);
            background-color: transparent;
        }

        .tab-button.active {
            color: var(--color-navy);
            border-bottom-color: var(--color-navy);
            background: transparent;
        }

        .tab-badge {
            display: inline-block;
            min-width: 24px;
            height: 24px;
            padding: 0 6px;
            background-color: var(--color-navy);
            color: #ffffff;
            border-radius: 100vh;
            font-size: 11px;
            font-weight: 700;
            text-align: center;
            line-height: 24px;
            margin-left: 6px;
        }

        .tab-button.active .tab-badge {
            background-color: var(--color-navy);
        }

        /* ===== STATS BAR ===== */
        .stats-bar {
            display: flex;
            gap: 6px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-card {
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--color-card-bg);
            padding: 6px 14px;
            border-radius: 20px;
            border: 1px solid rgba(36,54,104,0.08);
            font-size: 13px;
        }

        .stat-card::before {
            display: none;
        }

        .stat-label {
            font-family: var(--font-heading);
            font-size: 11px;
            font-weight: 500;
            color: var(--color-text-secondary);
            letter-spacing: 0.3px;
            text-transform: uppercase;
            margin-bottom: 0;
        }

        .stat-value {
            font-family: var(--font-heading);
            font-size: 15px;
            font-weight: 700;
            color: var(--color-navy);
            letter-spacing: 0;
        }

        /* ===== TOOLBAR ===== */
        .toolbar {
            display: flex;
            gap: 12px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 12px 16px;
            font-family: var(--font-body);
            font-size: 14px;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-button);
            background-color: var(--color-card-bg);
            color: var(--color-text-primary);
            transition: border-color var(--transition-smooth);
            letter-spacing: var(--letter-spacing-body);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--color-navy);
        }

        .search-input::placeholder {
            color: var(--color-text-secondary);
        }

        .toolbar-select {
            padding: 12px 16px;
            font-family: var(--font-body);
            font-size: 14px;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-button);
            background-color: var(--color-card-bg);
            color: var(--color-text-primary);
            cursor: pointer;
            transition: border-color var(--transition-smooth);
            letter-spacing: var(--letter-spacing-body);
        }

        .toolbar-select:focus {
            outline: none;
            border-color: var(--color-navy);
        }

        .toolbar-button {
            padding: 12px 20px;
            font-family: var(--font-heading);
            font-size: 13px;
            font-weight: 600;
            border: none;
            border-radius: var(--radius-button);
            cursor: pointer;
            transition: all var(--transition-smooth);
            letter-spacing: var(--letter-spacing-heading);
            text-transform: uppercase;
        }

        .toolbar-button-primary {
            background-color: #000000;
            color: #ffffff;
        }

        .toolbar-button-primary:hover {
            background-color: #ffffff;
            color: #000000;
            border: 2px solid #000000;
        }

        .toolbar-button-secondary {
            background-color: var(--color-card-bg);
            color: #000000;
            border: 2px solid #000000;
        }

        .toolbar-button-secondary:hover {
            background-color: #000000;
            color: #ffffff;
        }

        .view-toggle {
            display: flex;
            gap: 8px;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-button);
            padding: 4px;
            background-color: var(--color-card-bg);
        }

        .view-toggle-btn {
            padding: 8px 12px;
            background-color: transparent;
            border: none;
            cursor: pointer;
            font-size: 18px;
            transition: all var(--transition-smooth);
            border-radius: 4px;
        }

        .view-toggle-btn.active {
            background-color: var(--color-navy);
            color: #ffffff;
        }

        /* ===== CARDS GRID ===== */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .bean-card {
            background-color: var(--color-card-bg);
            border-radius: var(--radius-card);
            box-shadow: var(--shadow-subtle);
            overflow: hidden;
            transition: all var(--transition-smooth);
            position: relative;
            cursor: pointer;
            padding: 0;
        }

        .bean-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(36, 54, 104, 0.15);
        }

        .bean-card-accent {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
        }

        .bean-card-content {
            padding: 16px 20px 20px;
        }

        .bean-card-thumb {
            width: 100%;
            height: 160px;
            overflow: hidden;
            border-radius: 12px 12px 0 0;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .bean-card-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform var(--transition-smooth);
        }

        .bean-card:hover .bean-card-thumb img {
            transform: scale(1.05);
        }

        .bean-card-thumb-placeholder {
            width: 100%;
            height: 160px;
            background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
            border-radius: 12px 12px 0 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: #ccc;
        }

        .bean-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            gap: 12px;
        }

        .bean-card-name {
            font-family: var(--font-heading);
            font-size: 16px;
            font-weight: 700;
            color: var(--color-navy);
            letter-spacing: var(--letter-spacing-heading);
            line-height: 1.3;
            flex: 1;
        }

        .bean-card-actions {
            display: flex;
            gap: 8px;
        }

        .bean-card-action-btn {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity var(--transition-smooth);
        }

        .bean-card-action-btn:hover {
            opacity: 1;
        }

        .bean-card-meta {
            font-size: 13px;
            color: var(--color-text-secondary);
            margin-bottom: 10px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .bean-card-origin {
            font-weight: 500;
            color: var(--color-navy);
        }

        .bean-card-flavor {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .flavor-pill {
            background-color: rgba(36, 54, 104, 0.08);
            color: var(--color-navy);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            letter-spacing: var(--letter-spacing-body);
        }

        .bean-card-price {
            font-family: var(--font-heading);
            font-size: 18px;
            font-weight: 700;
            color: var(--color-navy);
            margin-bottom: 12px;
            letter-spacing: var(--letter-spacing-heading);
        }

        .bean-card-url {
            font-size: 12px;
        }


        /* ===== FRESHNESS INDICATOR ===== */
        .bean-freshness {
            margin-bottom: 12px;
            padding: 10px 12px;
            background: rgba(36, 54, 104, 0.03);
            border-radius: 10px;
        }

        .bean-freshness-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .bean-freshness-date {
            font-family: var(--font-heading);
            font-size: 11px;
            font-weight: 500;
            color: var(--color-text-secondary);
            letter-spacing: 0.05em;
        }

        .bean-freshness-status {
            font-family: var(--font-heading);
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .freshness-degassing .bean-freshness-status {
            background: rgba(122, 242, 224, 0.2);
            color: #0d9488;
        }
        .freshness-peak .bean-freshness-status {
            background: rgba(122, 242, 224, 0.25);
            color: #059669;
        }
        .freshness-good .bean-freshness-status {
            background: rgba(255, 215, 0, 0.2);
            color: #b45309;
        }
        .freshness-soon .bean-freshness-status {
            background: rgba(255, 159, 180, 0.25);
            color: #dc2626;
        }
        .freshness-past .bean-freshness-status {
            background: rgba(200, 200, 200, 0.3);
            color: #9ca3af;
        }

        .bean-freshness-bar {
            width: 100%;
            height: 4px;
            background: #e8e8e8;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 6px;
        }

        .bean-freshness-bar-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        .freshness-degassing .bean-freshness-bar-fill {
            background: linear-gradient(90deg, #7af2e0, #a7f3d0);
        }
        .freshness-peak .bean-freshness-bar-fill {
            background: linear-gradient(90deg, #059669, #7af2e0);
        }
        .freshness-good .bean-freshness-bar-fill {
            background: linear-gradient(90deg, #fbbf24, #fcd34d);
        }
        .freshness-soon .bean-freshness-bar-fill {
            background: linear-gradient(90deg, #ff9fb4, #fca5a5);
        }
        .freshness-past .bean-freshness-bar-fill {
            background: #d1d5db;
        }

        .bean-freshness-timeline {
            display: flex;
            justify-content: space-between;
            margin-top: 4px;
        }

        .bean-freshness-timeline span {
            font-size: 9px;
            color: #aaa;
            font-family: var(--font-heading);
            letter-spacing: 0.03em;
        }


        /* ===== ANALYTICS DASHBOARD ===== */
        .analytics-dashboard {
            padding-bottom: 40px;
        }

        .analytics-row {
            display: grid;
            gap: 20px;
            margin-bottom: 20px;
        }

        .analytics-row-3 {
            grid-template-columns: 1fr 1fr 1fr;
        }

        .analytics-row-2 {
            grid-template-columns: 1fr 1fr;
        }

        .analytics-row-1 {
            grid-template-columns: 1fr;
        }

        @media (max-width: 900px) {
            .analytics-row-3 {
                grid-template-columns: 1fr;
            }
            .analytics-row-2 {
                grid-template-columns: 1fr;
            }
        }

        .analytics-card {
            background: var(--color-card-bg);
            border-radius: var(--radius-card);
            box-shadow: var(--shadow-subtle);
            padding: 24px;
            position: relative;
            overflow: hidden;
        }

        .analytics-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-accent);
        }

        .analytics-card-title {
            font-family: var(--font-heading);
            font-size: 16px;
            font-weight: 700;
            color: var(--color-navy);
            letter-spacing: var(--letter-spacing-heading);
            margin-bottom: 16px;
        }

        .analytics-chart-container {
            position: relative;
            height: 260px;
        }

        .analytics-chart-tall {
            height: 350px;
        }

        .analytics-card-wide {
            grid-column: 1 / -1;
        }

        /* Purchase Recommendation */
        .purchase-rec {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 24px;
            align-items: start;
        }

        @media (max-width: 700px) {
            .purchase-rec {
                grid-template-columns: 1fr;
            }
        }

        .purchase-timing {
            background: linear-gradient(135deg, rgba(36, 54, 104, 0.06), rgba(122, 242, 224, 0.06));
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .purchase-timing-days {
            font-family: var(--font-heading);
            font-size: 48px;
            font-weight: 700;
            color: var(--color-navy);
            line-height: 1;
        }

        .purchase-timing-label {
            font-size: 13px;
            color: var(--color-text-secondary);
            margin-top: 4px;
        }

        .purchase-timing-status {
            font-family: var(--font-heading);
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            padding: 4px 12px;
            border-radius: 12px;
            display: inline-block;
            margin-top: 10px;
        }

        .purchase-rec-suggestions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .purchase-rec-item {
            background: rgba(36, 54, 104, 0.03);
            border-radius: 10px;
            padding: 14px 16px;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .purchase-rec-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .purchase-rec-text {
            font-size: 13px;
            line-height: 1.5;
            color: var(--color-text-primary);
        }

        .purchase-rec-text strong {
            color: var(--color-navy);
        }

        /* Cafe Pricing Table */
        .analytics-table-wrapper {
            overflow-x: auto;
        }

        .analytics-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .analytics-table th {
            background: rgba(36, 54, 104, 0.06);
            padding: 12px 16px;
            text-align: left;
            font-family: var(--font-heading);
            font-size: 11px;
            font-weight: 600;
            color: var(--color-navy);
            letter-spacing: 0.08em;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .analytics-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
        }

        .analytics-table tr:hover td {
            background: rgba(122, 242, 224, 0.05);
        }

        #cafe-pricing-table th {
            background: #fff !important;
            color: #333 !important;
            font-size: 12px;
            border-bottom: 2px solid #e0e0e0;
            vertical-align: bottom;
            padding-bottom: 10px;
        }

        .sortable-th {
            cursor: pointer;
            user-select: none;
            transition: background 0.15s;
        }
        .sortable-th:hover {
            background: #f0f4ff !important;
        }
        .sortable-th.sort-active {
            background: #e8edf8 !important;
        }
        .sort-arrow {
            font-size: 10px;
            opacity: 0.3;
        }
        .sort-arrow::after {
            content: '‚ñº';
        }
        .sortable-th.sort-asc .sort-arrow {
            opacity: 1;
        }
        .sortable-th.sort-asc .sort-arrow::after {
            content: '‚ñ≤';
        }
        .sortable-th.sort-desc .sort-arrow {
            opacity: 1;
        }
        .sortable-th.sort-desc .sort-arrow::after {
            content: '‚ñº';
        }

        .rarity-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.05em;
        }

        .rarity-legendary {
            background: rgba(255, 215, 0, 0.2);
            color: #b45309;
        }

        .rarity-rare {
            background: rgba(255, 159, 180, 0.2);
            color: #be185d;
        }

        .rarity-uncommon {
            background: rgba(122, 242, 224, 0.2);
            color: #0d9488;
        }

        .rarity-common {
            background: rgba(36, 54, 104, 0.1);
            color: var(--color-navy);
        }

        .cost-ratio-bar {
            display: inline-block;
            height: 6px;
            border-radius: 3px;
            margin-right: 8px;
            vertical-align: middle;
        }

        /* ===== DETAIL MODAL ===== */
        .detail-modal {
            max-width: 680px;
        }

        .detail-hero {
            width: calc(100% + 60px);
            margin: -30px -30px 0 -30px;
            height: 240px;
            overflow: hidden;
            border-radius: 16px 16px 0 0;
            background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .detail-hero img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .detail-hero-placeholder {
            font-size: 64px;
            color: #ccc;
        }

        .detail-hero-accent {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .detail-body {
            padding-top: 20px;
        }

        .detail-name {
            font-family: var(--font-heading);
            font-size: 22px;
            font-weight: 700;
            color: var(--color-navy);
            letter-spacing: var(--letter-spacing-heading);
            line-height: 1.3;
            margin-bottom: 4px;
        }

        .detail-roaster {
            font-size: 14px;
            color: var(--color-text-secondary);
            margin-bottom: 16px;
        }

        .detail-flavors {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .detail-flavor-pill {
            background: linear-gradient(135deg, rgba(255, 159, 180, 0.15), rgba(122, 242, 224, 0.15));
            color: var(--color-navy);
            padding: 6px 14px;
            border-radius: 16px;
            font-size: 13px;
            font-weight: 500;
            letter-spacing: 0.03em;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .detail-field {
            padding: 12px;
            background: rgba(36, 54, 104, 0.03);
            border-radius: 10px;
        }

        .detail-field-label {
            font-family: var(--font-heading);
            font-size: 10px;
            font-weight: 600;
            color: var(--color-text-secondary);
            letter-spacing: 0.1em;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .detail-field-value {
            font-size: 14px;
            font-weight: 500;
            color: var(--color-text-primary);
            line-height: 1.4;
        }

        .detail-field-wide {
            grid-column: 1 / -1;
        }

        .detail-price-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: linear-gradient(135deg, rgba(36, 54, 104, 0.06), rgba(122, 242, 224, 0.06));
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .detail-price {
            font-family: var(--font-heading);
            font-size: 24px;
            font-weight: 700;
            color: var(--color-navy);
            letter-spacing: var(--letter-spacing-heading);
        }

        .detail-weight {
            font-size: 14px;
            color: var(--color-text-secondary);
            font-weight: 500;
        }

        .detail-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .detail-action-btn {
            flex: 1;
            padding: 12px 16px;
            font-family: var(--font-heading);
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.08em;
            border-radius: var(--radius-button);
            cursor: pointer;
            transition: all var(--transition-smooth);
            text-align: center;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .detail-action-primary {
            background: var(--gradient-accent);
            color: #fff;
            border: none;
        }

        .detail-action-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 159, 180, 0.3);
        }

        .detail-action-secondary {
            background: transparent;
            color: var(--color-navy);
            border: 2px solid var(--color-navy);
        }

        .detail-action-secondary:hover {
            background: rgba(36, 54, 104, 0.05);
        }

        .bean-card-url a {
            color: var(--color-cyan);
            text-decoration: none;
            transition: color var(--transition-smooth);
            position: relative;
            z-index: 2;
        }

        .bean-card-url a:hover {
            color: var(--color-navy);
        }

        .bean-card-action-btn {
            position: relative;
            z-index: 2;
        }

        /* ===== TABLE VIEW ===== */
        .table-wrapper {
            background-color: var(--color-card-bg);
            border-radius: var(--radius-card);
            box-shadow: var(--shadow-subtle);
            overflow-x: auto;
            margin-bottom: 40px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        thead {
            background-color: var(--color-navy);
            color: #ffffff;
        }

        thead th {
            padding: 16px;
            text-align: left;
            font-family: var(--font-heading);
            font-weight: 600;
            letter-spacing: var(--letter-spacing-heading);
            cursor: pointer;
            user-select: none;
        }

        thead th:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        tbody tr {
            border-bottom: 1px solid var(--color-border);
            transition: background-color var(--transition-smooth);
        }

        tbody tr:hover {
            background-color: rgba(122, 242, 224, 0.08);
        }

        tbody td {
            padding: 16px;
            color: var(--color-text-primary);
        }

        /* ===== ROASTER GROUPS (Ê§úË®é‰∏≠) ===== */
        .roaster-group {
            background-color: var(--color-card-bg);
            border-radius: var(--radius-card);
            box-shadow: var(--shadow-subtle);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .roaster-header {
            padding: 20px;
            background: linear-gradient(135deg, rgba(36, 54, 104, 0.05) 0%, rgba(122, 242, 224, 0.05) 100%);
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color var(--transition-smooth);
        }

        .roaster-header:hover {
            background: linear-gradient(135deg, rgba(36, 54, 104, 0.1) 0%, rgba(122, 242, 224, 0.1) 100%);
        }

        .roaster-info {
            flex: 1;
        }

        .roaster-name {
            font-family: var(--font-heading);
            font-size: 18px;
            font-weight: 700;
            color: var(--color-navy);
            letter-spacing: var(--letter-spacing-heading);
            margin-bottom: 4px;
        }

        .roaster-meta {
            font-size: 13px;
            color: var(--color-text-secondary);
        }

        .roaster-toggle {
            font-size: 20px;
            transition: transform var(--transition-smooth);
        }

        .roaster-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .roaster-content {
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .roaster-content.collapsed {
            display: none;
        }

        /* ===== MODALS ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .modal {
            background-color: var(--color-card-bg);
            border-radius: var(--radius-card);
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            font-family: var(--font-heading);
            font-size: 24px;
            font-weight: 700;
            color: var(--color-navy);
            margin-bottom: 24px;
            letter-spacing: var(--letter-spacing-heading);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--color-text-secondary);
            transition: color var(--transition-smooth);
        }

        .modal-close-btn:hover {
            color: var(--color-navy);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-family: var(--font-heading);
            font-size: 13px;
            font-weight: 600;
            color: var(--color-navy);
            margin-bottom: 8px;
            letter-spacing: var(--letter-spacing-heading);
            text-transform: uppercase;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 12px 16px;
            font-family: var(--font-body);
            font-size: 14px;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-button);
            background-color: var(--color-bg);
            color: var(--color-text-primary);
            transition: border-color var(--transition-smooth);
            letter-spacing: var(--letter-spacing-body);
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--color-navy);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .color-picker-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .color-swatch {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform var(--transition-smooth);
            border: 2px solid transparent;
        }

        .color-swatch:hover {
            transform: scale(1.1);
        }

        .color-swatch.selected {
            border-color: var(--color-navy);
            box-shadow: 0 0 0 3px rgba(36, 54, 104, 0.2);
        }

        .photo-upload-area {
            position: relative;
            border: 2px dashed var(--color-border);
            border-radius: var(--radius-button);
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-smooth);
            background-color: rgba(122, 242, 224, 0.03);
        }

        .photo-upload-area:hover {
            border-color: #7af2e0;
            background-color: rgba(122, 242, 224, 0.08);
        }

        .photo-upload-area.dragover {
            border-color: #7af2e0;
            background-color: rgba(122, 242, 224, 0.15);
        }

        .photo-upload-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            pointer-events: none;
        }

        .photo-upload-icon {
            font-size: 36px;
            opacity: 0.8;
        }

        .photo-upload-text {
            font-family: var(--font-heading);
            font-size: 13px;
            font-weight: 600;
            color: var(--color-navy);
            letter-spacing: var(--letter-spacing-heading);
        }

        .photo-upload-subtext {
            font-family: var(--font-body);
            font-size: 12px;
            color: var(--color-text-secondary);
            letter-spacing: var(--letter-spacing-body);
        }

        .photo-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: var(--radius-button);
            margin-bottom: 12px;
            object-fit: contain;
        }

        .photo-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 12px;
        }

        .photo-action-btn {
            padding: 8px 16px;
            font-family: var(--font-body);
            font-size: 12px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-button);
            background-color: var(--color-bg);
            color: var(--color-text-primary);
            cursor: pointer;
            transition: all var(--transition-smooth);
        }

        .photo-action-btn:hover {
            background-color: #f5f5f5;
            border-color: #999;
        }

        .photo-action-remove:hover {
            color: #d32f2f;
            border-color: #d32f2f;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 30px;
            justify-content: flex-end;
        }

        .modal-button {
            padding: 12px 24px;
            font-family: var(--font-heading);
            font-size: 13px;
            font-weight: 600;
            border: none;
            border-radius: var(--radius-button);
            cursor: pointer;
            transition: all var(--transition-smooth);
            letter-spacing: var(--letter-spacing-heading);
            text-transform: uppercase;
        }

        .modal-button-primary {
            background: var(--gradient-accent);
            color: #ffffff;
        }

        .modal-button-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 159, 180, 0.3);
        }

        .modal-button-secondary {
            background-color: var(--color-bg);
            color: var(--color-navy);
            border: 2px solid var(--color-border);
        }

        .modal-button-secondary:hover {
            border-color: var(--color-navy);
        }

        .modal-button-danger {
            background-color: var(--color-coral);
            color: #ffffff;
        }

        .modal-button-danger:hover {
            opacity: 0.9;
        }

        /* ===== IMPORT PANEL ===== */
        .import-panel {
            background-color: var(--color-card-bg);
            border-radius: var(--radius-card);
            box-shadow: var(--shadow-subtle);
            padding: 24px;
            margin-bottom: 30px;
            border: 2px dashed var(--color-border);
            display: none;
        }

        .import-panel.active {
            display: block;
            animation: slideIn 0.3s ease;
        }

        .import-panel-title {
            font-family: var(--font-heading);
            font-size: 16px;
            font-weight: 700;
            color: var(--color-navy);
            margin-bottom: 16px;
            letter-spacing: var(--letter-spacing-heading);
        }

        .import-form {
            display: flex;
            gap: 12px;
        }

        .import-input {
            flex: 1;
            padding: 12px 16px;
            font-family: var(--font-body);
            font-size: 14px;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-button);
            background-color: var(--color-bg);
            color: var(--color-text-primary);
            transition: border-color var(--transition-smooth);
            letter-spacing: var(--letter-spacing-body);
        }

        .import-input:focus {
            outline: none;
            border-color: var(--color-navy);
        }

        /* ===== FOOTER ===== */
        footer {
            text-align: center;
            padding: 40px 20px;
            color: var(--color-text-secondary);
            font-size: 13px;
            letter-spacing: var(--letter-spacing-body);
        }

        .footer-text {
            background: var(--gradient-accent);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 600;
        }

        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--color-text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state-text {
            font-size: 16px;
            margin-bottom: 8px;
        }

        /* ===== UTILITY CLASSES ===== */
        .hidden {
            display: none !important;
        }

        .no-wrap {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .header-title {
                font-size: 24px;
            }

            .cards-grid,
            .roaster-content {
                grid-template-columns: 1fr;
            }

            .toolbar {
                flex-direction: column;
            }

            .search-input {
                min-width: 100%;
            }

            .modal {
                width: 95%;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .import-form {
                flex-direction: column;
            }

            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }

            table {
                font-size: 12px;
            }

            thead th,
            tbody td {
                padding: 12px 8px;
            }
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header>
        <div class="header-content">
            <h1 class="header-title">BEANS MANAGER</h1>
            <p class="header-subtitle">by POPX Coffee Project</p>
            <div class="header-accent"></div>
        </div>
    </header>

    <div class="container">
        <!-- TAB NAVIGATION -->
        <div class="tab-nav">
            <button class="tab-button active" data-tab="purchased">
                Ë≥ºÂÖ•Ê∏à„Åø
                <span class="tab-badge" id="purchased-count">29</span>
            </button>
            <button class="tab-button" data-tab="considering">
                Ê§úË®é‰∏≠
                <span class="tab-badge" id="considering-count">10</span>
            </button>
            <button class="tab-button" data-tab="analytics">
                üìä Analytics
            </button>
        </div>

        <!-- STATS BAR -->
        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-label">ÂÖ®„Ç≥„Éº„Éí„ÉºË±Ü</div>
                <div class="stat-value" id="stat-total-beans">39</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Âá∫Ë∫´ÂõΩ</div>
                <div class="stat-value" id="stat-origins">6</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">„É≠„Éº„Çπ„Çø„Éº</div>
                <div class="stat-value" id="stat-roasters">3</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Âπ≥Âùá‰æ°Ê†º</div>
                <div class="stat-value" id="stat-avg-price">¬•2.0k</div>
            </div>
        </div>

        <!-- TOOLBAR -->
        <div class="toolbar">
            <input type="text" class="search-input" id="search-input" placeholder="Ë±Ü„ÇíÊ§úÁ¥¢...">

            <select class="toolbar-select" id="filter-origin">
                <option value="">„Åô„Åπ„Å¶„ÅÆÂá∫Ë∫´ÂõΩ</option>
                <option value="Colombia">Colombia</option>
                <option value="Costa Rica">Costa Rica</option>
                <option value="Ethiopia">Ethiopia</option>
                <option value="Guatemala">Guatemala</option>
                <option value="Panama">Panama</option>
            </select>

            <select class="toolbar-select" id="filter-process">
                <option value="">„Åô„Åπ„Å¶„ÅÆ„Éó„É≠„Çª„Çπ</option>
                <option value="Washed">Washed</option>
                <option value="Natural">Natural</option>
                <option value="Honey">Honey</option>
                <option value="Anaerobic">Anaerobic</option>
                <option value="Anaerobic Washed">Anaerobic Washed</option>
                <option value="Anaerobic Natural">Anaerobic Natural</option>
            </select>

            <select class="toolbar-select" id="sort-by">
                <option value="name">ÂêçÂâç„Åß„ÇΩ„Éº„Éà</option>
                <option value="price-low">‰æ°Ê†º: ‰Ωé„ÅÑÈ†Ü</option>
                <option value="price-high">‰æ°Ê†º: È´ò„ÅÑÈ†Ü</option>
                <option value="origin">Âá∫Ë∫´ÂõΩ„Åß„ÇΩ„Éº„Éà</option>
                <option value="roaster">„É≠„Éº„Çπ„Çø„Éº„Åß„ÇΩ„Éº„Éà</option>
                <option value="freshness-peak">È£≤„ÅøÈ†É: Ëøë„ÅÑÈ†Ü</option>
                <option value="freshness-urgent">È£≤„ÅøÈ†É: ÊÄ•„ÅéÈ†Ü</option>
                <option value="date-new">Ë≥ºÂÖ•Êó•: Êñ∞„Åó„ÅÑÈ†Ü</option>
                <option value="date-old">Ë≥ºÂÖ•Êó•: Âè§„ÅÑÈ†Ü</option>
            </select>

            <div class="view-toggle">
                <button class="view-toggle-btn active" id="view-card" title="„Ç´„Éº„ÉâË°®Á§∫">üìã</button>
                <button class="view-toggle-btn" id="view-table" title="„ÉÜ„Éº„Éñ„É´Ë°®Á§∫">üìä</button>
            </div>

            <button class="toolbar-button toolbar-button-primary" id="btn-add-bean">+ Ë±Ü„ÇíËøΩÂä†</button>
            <button class="toolbar-button toolbar-button-secondary" id="btn-import-url">URL„Ç§„É≥„Éù„Éº„Éà</button>
            <button class="toolbar-button toolbar-button-secondary" id="btn-export-csv">CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
        </div>

        <!-- IMPORT PANEL -->
        <div class="import-panel" id="import-panel">
            <div class="import-panel-title">URL„Åã„ÇâË±Ü„ÇíËøΩÂä†</div>
            <div class="import-form">
                <input type="text" class="import-input" id="import-url-input" placeholder="„Ç≥„Éº„Éí„ÉºË±Ü„ÅÆURL„ÇíË≤º„Çä‰ªò„Åë...">
                <button class="toolbar-button toolbar-button-primary" id="btn-import-submit">„Ç§„É≥„Éù„Éº„Éà</button>
                <button class="toolbar-button toolbar-button-secondary" id="btn-import-cancel">„Ç≠„É£„É≥„Çª„É´</button>
            </div>
        </div>

        <!-- CONTENT AREA -->
        <div id="content-purchased" class="tab-content active">
            <div id="purchased-view-card" class="cards-grid"></div>
            <div id="purchased-view-table" class="table-wrapper hidden">
                <table id="purchased-table">
                    <thead>
                        <tr>
                            <th>ÂêçÂâç</th>
                            <th>„É≠„Éº„Çπ„Çø„Éº</th>
                            <th>Âá∫Ë∫´ÂõΩ</th>
                            <th>„Éó„É≠„Çª„Çπ</th>
                            <th>‰æ°Ê†º</th>
                            <th>„Ç¢„ÇØ„Ç∑„Éß„É≥</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="purchased-empty" class="empty-state hidden">
                <div class="empty-state-icon">‚òï</div>
                <div class="empty-state-text">Ë≥ºÂÖ•Ê∏à„Åø„ÅÆË±Ü„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</div>
            </div>
        </div>

        <div id="content-considering" class="tab-content hidden">
            <div id="considering-view-card"></div>
            <div id="considering-view-table" class="table-wrapper hidden">
                <table id="considering-table">
                    <thead>
                        <tr>
                            <th>ÂêçÂâç</th>
                            <th>„É≠„Éº„Çπ„Çø„Éº</th>
                            <th>Âá∫Ë∫´ÂõΩ</th>
                            <th>„Éó„É≠„Çª„Çπ</th>
                            <th>‰æ°Ê†º</th>
                            <th>ÂÑ™ÂÖàÂ∫¶</th>
                            <th>„Ç¢„ÇØ„Ç∑„Éß„É≥</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="considering-empty" class="empty-state hidden">
                <div class="empty-state-icon">ü§î</div>
                <div class="empty-state-text">Ê§úË®é‰∏≠„ÅÆË±Ü„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</div>
            </div>
        </div>

        <div id="content-analytics" class="tab-content hidden">
            <div class="analytics-dashboard">
                <!-- Row 1: Distribution Charts -->
                <div class="analytics-row analytics-row-3">
                    <div class="analytics-card">
                        <div class="analytics-card-title">üåç Origin</div>
                        <div class="analytics-chart-container">
                            <canvas id="chart-origin"></canvas>
                        </div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-card-title">‚öóÔ∏è Process</div>
                        <div class="analytics-chart-container">
                            <canvas id="chart-process"></canvas>
                        </div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-card-title">‚òï Flavor Profile</div>
                        <div class="analytics-chart-container analytics-chart-tall">
                            <canvas id="chart-flavor"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Row 2: Freshness + Spending -->
                <div class="analytics-row analytics-row-2">
                    <div class="analytics-card">
                        <div class="analytics-card-title">üïê Freshness Status</div>
                        <div class="analytics-chart-container">
                            <canvas id="chart-freshness"></canvas>
                        </div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-card-title">üí∞ Monthly Spending</div>
                        <div class="analytics-chart-container">
                            <canvas id="chart-spending"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Row 3: Purchase Recommendation -->
                <div class="analytics-row analytics-row-1">
                    <div class="analytics-card analytics-card-wide">
                        <div class="analytics-card-title">üõí Next Purchase Timing</div>
                        <div id="purchase-recommendation"></div>
                    </div>
                </div>

                <!-- Row 4: Cafe Pricing -->
                <div class="analytics-row analytics-row-1">
                    <div class="analytics-card analytics-card-wide">
                        <div class="analytics-card-title">‚òï Cafe Pricing Suggestions</div>
                        <div class="analytics-table-wrapper">
                            <table class="analytics-table" id="cafe-pricing-table">
                                <thead>
                                    <tr>
                                        <th data-sort="name" class="sortable-th">Ë±Ü <span class="sort-arrow"></span></th>
                                        <th data-sort="roaster" class="sortable-th">„É≠„Éº„Çπ„Çø„Éº <span class="sort-arrow"></span></th>
                                        <th data-sort="bagPrice" class="sortable-th">1Ë¢ã <span class="sort-arrow"></span><br><span style="display:inline-block;margin-top:4px;font-size:9px;font-weight:700;color:#fff;background:#e74c3c;padding:1px 6px;border-radius:8px;letter-spacing:0;">Âéü‰æ°</span></th>
                                        <th data-sort="costPer10g" class="sortable-th">1ÊùØ (10g) <span class="sort-arrow"></span><br><span style="display:inline-block;margin-top:4px;font-size:9px;font-weight:700;color:#fff;background:#e74c3c;padding:1px 6px;border-radius:8px;letter-spacing:0;">Âéü‰æ°</span></th>
                                        <th data-sort="costPer15g" class="sortable-th">1ÊùØ (15g) <span class="sort-arrow"></span><br><span style="display:inline-block;margin-top:4px;font-size:9px;font-weight:700;color:#fff;background:#e74c3c;padding:1px 6px;border-radius:8px;letter-spacing:0;">Âéü‰æ°</span></th>
                                        <th data-sort="rarityScore" class="sortable-th">Â∏åÂ∞ëÊÄß <span class="sort-arrow"></span></th>
                                        <th data-sort="sellPrice10g" class="sortable-th">1ÊùØ (10g) <span class="sort-arrow"></span><br><span style="display:inline-block;margin-top:4px;font-size:9px;font-weight:700;color:#fff;background:#243668;padding:1px 6px;border-radius:8px;letter-spacing:0;">Â£≤ÂÄ§</span></th>
                                        <th data-sort="sellPrice15g" class="sortable-th">1ÊùØ (15g) <span class="sort-arrow"></span><br><span style="display:inline-block;margin-top:4px;font-size:9px;font-weight:700;color:#fff;background:#243668;padding:1px 6px;border-radius:8px;letter-spacing:0;">Â£≤ÂÄ§</span></th>
                                        <th data-sort="grossMargin" class="sortable-th">Á≤óÂà©Áéá <span class="sort-arrow"></span></th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- BEAN DETAIL MODAL -->
    <div class="modal-overlay" id="detail-modal">
        <div class="modal detail-modal">
            <div class="modal-header">
                <span id="detail-title">Ë±Ü„ÅÆË©≥Á¥∞</span>
                <button class="modal-close-btn" id="detail-modal-close">‚úï</button>
            </div>
            <div id="detail-content"></div>
        </div>
    </div>

    <!-- FOOTER -->
    <footer>
        <p><span class="footer-text">POPX Coffee Project ¬© 2026</span></p>
    </footer>

    <!-- ADD/EDIT MODAL -->
    <div class="modal-overlay" id="bean-modal">
        <div class="modal">
            <div class="modal-header">
                <span id="modal-title">Ë±Ü„ÇíËøΩÂä†</span>
                <button class="modal-close-btn" id="modal-close">‚úï</button>
            </div>

            <form id="bean-form">
                <div class="form-group">
                    <label class="form-label">Ë±Ü„ÅÆÂêçÂâç</label>
                    <input type="text" class="form-input" id="form-name" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">„É≠„Éº„Çπ„Çø„Éº</label>
                        <input type="text" class="form-input" id="form-roaster" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Âá∫Ë∫´ÂõΩ</label>
                        <input type="text" class="form-input" id="form-origin" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Âú∞Âüü</label>
                        <input type="text" class="form-input" id="form-region">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ëæ≤Â†¥</label>
                        <input type="text" class="form-input" id="form-farm">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">ÂìÅÁ®Æ</label>
                        <input type="text" class="form-input" id="form-variety">
                    </div>
                    <div class="form-group">
                        <label class="form-label">„Éó„É≠„Çª„Çπ</label>
                        <input type="text" class="form-input" id="form-process">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Ê®ôÈ´ò</label>
                        <input type="text" class="form-input" id="form-elevation">
                    </div>
                    <div class="form-group">
                        <label class="form-label">‰æ°Ê†º</label>
                        <input type="text" class="form-input" id="form-price" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">ÈáçÈáè</label>
                        <input type="text" class="form-input" id="form-weight">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÁîüÁî£ËÄÖ</label>
                        <input type="text" class="form-input" id="form-producer">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">„Éï„É¨„Éº„Éê„Éº„Éé„Éº„Éà</label>
                    <input type="text" class="form-input" id="form-flavor" placeholder="‰æãÔºöCitrus, Red Fruit, Chocolate">
                </div>

                <div class="form-group">
                    <label class="form-label">URL</label>
                    <input type="url" class="form-input" id="form-url">
                </div>

                <div class="form-group">
                    <label class="form-label">ÂÜôÁúü / Photo</label>
                    <div class="photo-upload-area" id="photo-upload-area">
                        <input type="file" accept="image/*" id="form-photo-input" style="display: none;">
                        <div class="photo-upload-placeholder">
                            <div class="photo-upload-icon">üì∑</div>
                            <div class="photo-upload-text">„ÇØ„É™„ÉÉ„ÇØ„Åæ„Åü„ÅØ„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶ÂÜôÁúü„ÇíËøΩÂä†</div>
                            <div class="photo-upload-subtext">Add Photo</div>
                        </div>
                        <img id="form-photo-preview" class="photo-preview" style="display: none;">
                        <div class="photo-actions" id="photo-actions" style="display: none;">
                            <button type="button" class="photo-action-btn photo-action-remove" id="btn-remove-photo">‚úï ÂâäÈô§</button>
                        </div>
                    </div>
                </div>

                <div id="character-fields" class="form-group hidden">
                    <label class="form-label">„Ç≠„É£„É©„ÇØ„Çø„ÉºÂêç</label>
                    <input type="text" class="form-input" id="form-character-name">

                    <label class="form-label" style="margin-top: 16px;">„Ç´„É©„Éº„Éë„É¨„ÉÉ„Éà</label>
                    <div class="color-picker-group" id="color-palette">
                        <div class="color-swatch" style="background-color: #ff9fb4;" data-color="#ff9fb4" title="Pink"></div>
                        <div class="color-swatch" style="background-color: #7af2e0;" data-color="#7af2e0" title="Cyan"></div>
                        <div class="color-swatch" style="background-color: #243668;" data-color="#243668" title="Navy"></div>
                        <div class="color-swatch" style="background-color: #ffd700;" data-color="#ffd700" title="Gold"></div>
                        <div class="color-swatch" style="background-color: #ff6b6b;" data-color="#ff6b6b" title="Coral"></div>
                        <div class="color-swatch" style="background-color: #98d8c8;" data-color="#98d8c8" title="Mint"></div>
                        <div class="color-swatch" style="background-color: #c4b5fd;" data-color="#c4b5fd" title="Lavender"></div>
                    </div>

                    <label class="form-label" style="margin-top: 16px;">„Çπ„Éà„Éº„É™„Éº</label>
                    <textarea class="form-textarea" id="form-story" placeholder="„Åì„ÅÆË±Ü„Å´„Å§„ÅÑ„Å¶„ÅÆ„Çπ„Éà„Éº„É™„Éº„ÇíÊõ∏„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ..."></textarea>
                </div>

                <div id="considering-fields" class="form-group hidden">
                    <label class="form-label">ÂÑ™ÂÖàÂ∫¶</label>
                    <select class="form-select" id="form-priority">
                        <option value="normal">ÈÄöÂ∏∏</option>
                        <option value="high">È´ò</option>
                    </select>

                    <label class="form-label" style="margin-top: 16px;">„É°„É¢</label>
                    <textarea class="form-textarea" id="form-notes" placeholder="„Åì„ÅÆË±Ü„Å´„Å§„ÅÑ„Å¶„ÅÆ„É°„É¢..."></textarea>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="modal-button modal-button-secondary" id="modal-cancel">„Ç≠„É£„É≥„Çª„É´</button>
                    <button type="button" class="modal-button modal-button-danger hidden" id="modal-delete">ÂâäÈô§</button>
                    <button type="submit" class="modal-button modal-button-primary">‰øùÂ≠ò</button>
                </div>
            </form>
        </div>
    </div>

    <!-- CHARACTER MODAL -->
    <div class="modal-overlay" id="character-modal">
        <div class="modal">
            <div class="modal-header">
                <span id="character-modal-title">„Ç≠„É£„É©„ÇØ„Çø„ÉºÈñãÁô∫</span>
                <button class="modal-close-btn" id="character-modal-close">‚úï</button>
            </div>

            <form id="character-form">
                <div class="form-group">
                    <label class="form-label">Ë±Ü„ÅÆÂêçÂâç</label>
                    <input type="text" class="form-input" id="char-bean-name" disabled>
                </div>

                <div class="form-group">
                    <label class="form-label">„Ç≠„É£„É©„ÇØ„Çø„ÉºÂêç</label>
                    <input type="text" class="form-input" id="char-name">
                </div>

                <div class="form-group">
                    <label class="form-label">„Ç´„É©„Éº„Éë„É¨„ÉÉ„Éà</label>
                    <div class="color-picker-group" id="char-color-palette">
                        <div class="color-swatch" style="background-color: #ff9fb4;" data-color="#ff9fb4" title="Pink"></div>
                        <div class="color-swatch" style="background-color: #7af2e0;" data-color="#7af2e0" title="Cyan"></div>
                        <div class="color-swatch" style="background-color: #243668;" data-color="#243668" title="Navy"></div>
                        <div class="color-swatch" style="background-color: #ffd700;" data-color="#ffd700" title="Gold"></div>
                        <div class="color-swatch" style="background-color: #ff6b6b;" data-color="#ff6b6b" title="Coral"></div>
                        <div class="color-swatch" style="background-color: #98d8c8;" data-color="#98d8c8" title="Mint"></div>
                        <div class="color-swatch" style="background-color: #c4b5fd;" data-color="#c4b5fd" title="Lavender"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">„Çπ„Éà„Éº„É™„Éº</label>
                    <textarea class="form-textarea" id="char-story" placeholder="„Åì„ÅÆË±Ü„Å´„Å§„ÅÑ„Å¶„ÅÆ„Çπ„Éà„Éº„É™„Éº„ÇíÊõ∏„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ..."></textarea>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="modal-button modal-button-secondary" id="character-modal-cancel">„Ç≠„É£„É≥„Çª„É´</button>
                    <button type="submit" class="modal-button modal-button-primary">‰øùÂ≠ò</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ===== DATA MANAGEMENT =====
        let purchasedBeans = [
            { id: 1, name: "Geisha - Luna Bermudez - Finca El Paraiso", roaster: "Hydrangea Coffee", origin: "Colombia", region: "El Paraiso, Cauca", farm: "Finca El Paraiso", producer: "Samuel Diego Bermudez", variety: "Geisha", process: "Double Fermentation Thermal Shock", elevation: "1930m", flavor: "Egg Waffle, Blueberry, High Mountain Oolong Tea", price: "$29.00 (¬•4,408)", priceJPY: 4408, weight: "4oz (114g)", orderDate: "2026-02-13", url: "https://hydrangea.coffee/products/luna-bermudez", image: "https://hydrangea.coffee/cdn/shop/files/EggWaffle_Blueberry_HighMountainOolongTea.jpg?v=1693232333", characterName: "", colorPalette: [], story: "" },
            { id: 2, name: "Castillo - Thermal Shock Decaf - Finca El Paraiso", roaster: "Hydrangea Coffee", origin: "Colombia", region: "El Paraiso, Cauca", farm: "Finca El Paraiso", producer: "Samuel Diego Bermudez", variety: "Castillo", process: "Decaffeinated Thermal Shock Washed", elevation: "1960m", flavor: "Raspberries, Peach, Key Lime", price: "$18.00 (¬•2,736)", priceJPY: 2736, weight: "4oz (114g)", orderDate: "2026-02-13", url: "https://hydrangea.coffee/products/el-paraiso-decaf", image: "https://hydrangea.coffee/cdn/shop/products/RasberriesPeachKeyLime.jpg?v=1680149091", characterName: "", colorPalette: [], story: "" },
            { id: 3, name: "Castillo - Lychee - Finca El Paraiso", roaster: "Hydrangea Coffee", origin: "Colombia", region: "El Paraiso, Cauca", farm: "Finca El Paraiso", producer: "Samuel Diego Bermudez", variety: "Castillo", process: "Double Anaerobic Thermal Shock", elevation: "1960m", flavor: "Osmanthus, Lychee, Kasugai Gummies", price: "$17.50 (¬•2,660)", priceJPY: 2660, weight: "4oz (114g)", orderDate: "2026-02-13", url: "https://hydrangea.coffee/products/el-paraiso-lychee", image: "https://hydrangea.coffee/cdn/shop/products/Lychee_Osmanthus_PeachGummy.png?v=1677851477", characterName: "", colorPalette: [], story: "" },
            { id: 4, name: "Geisha - Letty Bermudez - Finca El Paraiso", roaster: "Hydrangea Coffee", origin: "Colombia", region: "El Paraiso, Cauca", farm: "Finca El Paraiso", producer: "Samuel Diego Bermudez", variety: "Geisha", process: "Double Fermentation Thermal Shock", elevation: "1930m", flavor: "White Peach, Jasmine Milk Tea, Dried Rose", price: "$29.00 (¬•4,408)", priceJPY: 4408, weight: "4oz (114g)", orderDate: "2026-02-13", url: "https://hydrangea.coffee/products/letty-bermudez", image: "https://hydrangea.coffee/cdn/shop/products/JasmineMilkTea_WhitePeachBlueBG.png?v=1675618863", characterName: "", colorPalette: [], story: "" },
            { id: 5, name: "Gesha - Iridescence - Savage Coffee", roaster: "Hydrangea Coffee", origin: "Panama", region: "Volcan, Chiriqui", farm: "Savage Coffee", producer: "Jamison Savage", variety: "Gesha", process: "Carbonic Macerated, Washed", elevation: "1800m", flavor: "Pomelo, Orange Blossom, Pineapple", price: "$33.50 (¬•5,092)", priceJPY: 5092, weight: "4oz (114g)", orderDate: "2026-02-13", url: "https://hydrangea.coffee/products/gesha-iridescence-savage-coffee", image: "https://hydrangea.coffee/cdn/shop/files/Pomelo_orangeblossom_pineapple.jpg?v=1750445940", characterName: "", colorPalette: [], story: "" },
            { id: 6, name: "Gesha - Horizon - Don Eduardo", roaster: "Hydrangea Coffee", origin: "Panama", region: "Boquete, Chiriqui", farm: "Don Eduardo Estate", producer: "Harold Sabin", variety: "Gesha", process: "Yeast Inoculated Natural, Washed Finish", elevation: "1800m", flavor: "Strawberry, Plum, Dahlia", price: "$57.50 (¬•8,740)", priceJPY: 8740, weight: "4oz (114g)", orderDate: "2026-02-13", url: "https://hydrangea.coffee/products/gesha-horizon-don-edwardo", image: "https://hydrangea.coffee/cdn/shop/files/Strawberry_Plum_Purpledahliaflowers.jpg?v=1769900536", characterName: "", colorPalette: [], story: "" },
            { id: 7, name: "SL28 - Anaerobic Natural - Volcan Azul", roaster: "Hydrangea Coffee", origin: "Costa Rica", region: "West Valley", farm: "Volcan Azul", producer: "Alejo Castro", variety: "SL28", process: "Anaerobic Natural", elevation: "1500m", flavor: "Mulled Red Wine, Date, Floral", price: "$20.00 (¬•3,040)", priceJPY: 3040, weight: "4oz (114g)", orderDate: "2026-02-13", url: "https://hydrangea.coffee/products/costa-rica-volcan-azul-sl28", image: "https://hydrangea.coffee/cdn/shop/products/IMG_0678.png?v=1673581603", characterName: "", colorPalette: [], story: "" },
            { id: 8, name: "Gesha - Natural - Finca Inmaculada", roaster: "Hydrangea Coffee", origin: "Colombia", region: "Valle del Cauca", farm: "Finca Inmaculada", producer: "The Hologuin Family", variety: "Gesha", process: "Natural", elevation: "1500-1700m", flavor: "Guava, Red Plum, Carnation", price: "$22.00 (¬•3,344)", priceJPY: 3344, weight: "4oz (114g)", orderDate: "2026-02-13", url: "https://hydrangea.coffee/products/gesha-natural-finca-inmaculada-fellow-farms-project", image: "https://hydrangea.coffee/cdn/shop/files/Guava_RedPlum_Carnation.jpg?v=1770505473", characterName: "", colorPalette: [], story: "" },
            { id: 9, name: "Gesha - Honey 753JHF - Finca Jurutungo", roaster: "Hydrangea Coffee", origin: "Panama", region: "Chiriqui", farm: "Finca Jurutungo", producer: "Jos√© 'Pocho' Gallardo", variety: "Gesha", process: "Honey", elevation: "1800-1950m", flavor: "Sparkling Rose, Stone Fruit, Floral", price: "$30.00 (¬•4,560)", priceJPY: 4560, weight: "4oz (114g)", orderDate: "2026-02-13", url: "https://hydrangea.coffee/products/gesha-honey-753jhf-finca-jurutungo", image: "https://hydrangea.coffee/cdn/shop/files/Sparklingrose_Stonefruit_Floral.jpg?v=1755305452", characterName: "", colorPalette: [], story: "" },
            { id: 10, name: "Aroma Nativo Sidra Lactic Lot #212", roaster: "Tanat Coffee", origin: "Colombia", region: "", variety: "Sidra", process: "Lactic", price: "‚Ç¨21.71 (¬•3,937)", priceJPY: 3937, weight: "100g", flavor: "", elevation: "", orderDate: "2026-02-13", url: "https://tanat.coffee/en/boutique/aroma-nativo-sidra-lactic-lot-212/", image: "https://tanat.coffee/wp-content/uploads/2026/01/PAQUETWEBMICROLOT_SidraLactic212.png", characterName: "", colorPalette: [], story: "" },
            { id: 11, name: "Finca la Riviera Pink Bourbon", roaster: "Tanat Coffee", origin: "Colombia", region: "", variety: "Pink Bourbon", process: "Washed", price: "‚Ç¨14.12 (¬•2,561)", priceJPY: 2561, weight: "200g", flavor: "Peach, Dragon Fruit, Mandarin, Lychee", elevation: "", orderDate: "2026-02-13", url: "https://tanat.coffee/en/boutique/finca-la-riviera-pink-bourbon/", image: "https://tanat.coffee/wp-content/uploads/2025/07/PAQUETWEB_1FincaRivieraPB25.png", characterName: "", colorPalette: [], story: "" },
            { id: 12, name: "Finca la Riviera Sidra Tanat Lot", roaster: "Tanat Coffee", origin: "Colombia", region: "", variety: "Sidra", process: "Anaerobic Natural", price: "‚Ç¨22.90 (¬•4,153)", priceJPY: 4153, weight: "200g", flavor: "Blood Orange, Strawberry, Lavender, Honey", elevation: "", orderDate: "2026-02-13", url: "https://tanat.coffee/en/boutique/finca-la-riviera-sidra-tanat-lot/", image: "https://tanat.coffee/wp-content/uploads/2025/12/PAQUETWEB_1FincaRivieraSidraTanat.png", characterName: "", colorPalette: [], story: "" },
            { id: 13, name: "Finca Milan Vanilla Process", roaster: "Tanat Coffee", origin: "Colombia", region: "", variety: "", process: "Vanilla Process", price: "‚Ç¨18.86 (¬•3,420)", priceJPY: 3420, weight: "200g", flavor: "Vanilla, Nougat, Cinnamon", elevation: "", producer: "Julio Madrid", orderDate: "2026-02-13", url: "https://tanat.coffee/en/boutique/finca-milan-vanilla-process/", image: "https://tanat.coffee/wp-content/uploads/2025/06/PAQUETWEB_Vanilla-3.png", characterName: "", colorPalette: [], story: "" },
            { id: 14, name: "Alo Dark Room Natural Lot #27", roaster: "Tanat Coffee", origin: "Ethiopia", region: "", variety: "", process: "Natural", price: "‚Ç¨34.98 (¬•6,344)", priceJPY: 6344, weight: "100g", flavor: "Floral, Fruity", elevation: "", orderDate: "2026-02-13", url: "https://tanat.coffee/en/boutique/alo-dark-room-natural-lot-27/", image: "https://tanat.coffee/wp-content/uploads/2026/02/PAQUETWEBMICROLOT_darkRoom27.png", characterName: "", colorPalette: [], story: "" },
            { id: 15, name: "Alo Dark Room Washed Lot #13", roaster: "Tanat Coffee", origin: "Ethiopia", region: "", variety: "", process: "Washed", price: "‚Ç¨34.98 (¬•6,344)", priceJPY: 6344, weight: "100g", flavor: "Floral, Fruity", elevation: "", orderDate: "2026-02-13", url: "https://tanat.coffee/en/boutique/alo-dark-room-washed-lot-13/", image: "https://tanat.coffee/wp-content/uploads/2026/02/PAQUETWEBMICROLOT_DarkRoom13.png", characterName: "", colorPalette: [], story: "" },
            { id: 16, name: "Ana Sora Anaerobic Natural", roaster: "Tanat Coffee", origin: "Ethiopia", region: "Guji", variety: "", process: "Anaerobic Natural", price: "‚Ç¨13.90 (¬•2,521)", priceJPY: 2521, weight: "200g", flavor: "Strawberry, White Peach, Black Tea", orderDate: "2026-02-13", url: "https://tanat.coffee/en/boutique/ana-sora-anaerobic-natural/", image: "https://tanat.coffee/wp-content/uploads/2025/10/PAQUETWEB_AnaSora.png", characterName: "", colorPalette: [], story: "" },
            { id: 17, name: "Elto Elora Anaerobic 72h", roaster: "Tanat Coffee", origin: "Ethiopia", region: "", variety: "", process: "Anaerobic 72h", price: "‚Ç¨19.90 (¬•3,609)", priceJPY: 3609, weight: "200g", flavor: "Mandarin, Star Fruit, Strawberry Blossom, Pomelo", orderDate: "2026-02-13", url: "https://tanat.coffee/en/boutique/elto-elora-anaerobic-72h/", image: "https://tanat.coffee/wp-content/uploads/2025/09/PAQUETWEB_Elora72H.png", characterName: "", colorPalette: [], story: "" },
            { id: 18, name: "El Injerto Geisha Washed", roaster: "Tanat Coffee", origin: "Guatemala", region: "", variety: "Geisha", process: "Washed", price: "‚Ç¨18.86 (¬•3,420)", priceJPY: 3420, weight: "100g", flavor: "White Flowers, Honey, Lemon, Grapefruit", orderDate: "2026-02-13", url: "https://tanat.coffee/en/boutique/el-injerto-geisha-washed/", image: "https://tanat.coffee/wp-content/uploads/2025/02/PAQUETWEBMICROLOT_InjertoGW.png", characterName: "", colorPalette: [], story: "" },
            { id: 19, name: "Abu #3160 Geisha Washed Anaerobic", roaster: "Tanat Coffee", origin: "Panama", region: "", variety: "Geisha", process: "Washed Anaerobic", price: "‚Ç¨33.08 (¬•5,999)", priceJPY: 5999, weight: "100g", flavor: "", orderDate: "2026-02-13", url: "https://tanat.coffee/en/boutique/abu-3160-geisha-washed-anaerobic/", image: "https://tanat.coffee/wp-content/uploads/2026/01/PAQUETWEBMICROLOT_Abu3160.png", characterName: "", colorPalette: [], story: "" },
            { id: 20, name: "Carmen Estate Palomar GW Lot 4", roaster: "Tanat Coffee", origin: "Panama", region: "", variety: "Geisha", process: "Washed", price: "‚Ç¨23.90 (¬•4,334)", priceJPY: 4334, weight: "100g", flavor: "Apricot, Jasmine, Lemon, White Peach", orderDate: "2026-02-13", url: "https://tanat.coffee/en/boutique/carmen-estate-palomar-gw-lot-4/", image: "https://tanat.coffee/wp-content/uploads/2025/12/PAQUETWEBMICROLOT_PalomarGW.png", characterName: "", colorPalette: [], story: "" },
            { id: 21, name: "Finca Hartmann Great Reserve GW Lot 18", roaster: "Tanat Coffee", origin: "Panama", region: "", variety: "Geisha", process: "Washed", price: "‚Ç¨42.56 (¬•7,718)", priceJPY: 7718, weight: "100g", flavor: "Jasmine, Peach, Lemon Candy", elevation: "1900m", orderDate: "2026-02-13", url: "https://tanat.coffee/en/boutique/finca-hartmann-great-reserve-gw-lot-18/", image: "https://tanat.coffee/wp-content/uploads/2026/01/PAQUETWEBMICROLOT_HartmannGreatR18.png", characterName: "", colorPalette: [], story: "" },
            { id: 22, name: "Finca La Cabra GW Tanat Lot", roaster: "Tanat Coffee", origin: "Panama", region: "", variety: "Geisha", process: "Washed", price: "‚Ç¨29.29 (¬•5,312)", priceJPY: 5312, weight: "100g", flavor: "White Peach, Lemongrass, Green Tea, Flowers", orderDate: "2026-02-13", url: "https://tanat.coffee/en/boutique/finca-la-cabra-gw-tanat-lot/", image: "https://tanat.coffee/wp-content/uploads/2026/02/PAQUETWEBMICROLOT_CabraGWTanatLot.png", characterName: "", colorPalette: [], story: "" },
            { id: 23, name: "Finca Sophia GN5 Colibr√≠", roaster: "Tanat Coffee", origin: "Panama", region: "", variety: "Geisha", process: "Natural", price: "‚Ç¨47.30 (¬•8,578)", priceJPY: 8578, weight: "4x15g", flavor: "Red Berries, Bergamot, Raisin, Black Tea", orderDate: "2026-02-13", url: "https://tanat.coffee/en/boutique/finca-sophia-gn5-colibri/", image: "https://tanat.coffee/wp-content/uploads/2026/01/SOPHIAGN5-BOX.png", characterName: "", colorPalette: [], story: "" },
            { id: 24, name: "Finca Sophia GW1 Piedra", roaster: "Tanat Coffee", origin: "Panama", region: "", variety: "Geisha", process: "Washed", price: "‚Ç¨56.78 (¬•10,297)", priceJPY: 10297, weight: "4x15g", flavor: "Lemon Candy, Bergamot, Orange, Chamomile", orderDate: "2026-02-13", url: "https://tanat.coffee/en/boutique/finca-sophia-gw1-piedra/", image: "https://tanat.coffee/wp-content/uploads/2025/12/SOPHIAGW1-BOX.png", characterName: "", colorPalette: [], story: "" },
            { id: 25, name: "El Injerto SL-28 Washed", roaster: "Tanat Coffee", origin: "Guatemala", region: "", variety: "SL-28", process: "Washed", price: "‚Ç¨22.65 (¬•4,108)", priceJPY: 4108, weight: "200g", flavor: "Blackcurrant, Cardamom, Date", orderDate: "2026-02-13", url: "https://tanat.coffee/en/boutique/el-injerto-sl-28-washed/", image: "https://tanat.coffee/wp-content/uploads/2025/10/PAQUETWEB_INjertoSL28WASH.png", characterName: "", colorPalette: [], story: "" },
            { id: 26, name: "Gesha Village Surma Lot 25/051 Natural", roaster: "Tanat Coffee", origin: "Ethiopia", region: "West Omo", variety: "Geisha 1931", process: "Natural", price: "‚Ç¨26.45 (¬•4,797)", priceJPY: 4797, weight: "100g", flavor: "Oolong, Peach, Honey, Cherry Blossom, Citrus", elevation: "1900-2060m", orderDate: "2026-02-13", url: "https://tanat.coffee/en/boutique/gesha-village-surma-natural-lot-25-051/", image: "https://tanat.coffee/wp-content/uploads/2025/12/PAQUETWEBMICROLOT_Surma25-051.png", characterName: "", colorPalette: [], story: "" },
            { id: 27, name: "Elida Aguacate Geisha Washed 3004", roaster: "Tanat Coffee", origin: "Panama", region: "Volc√°n Bar√∫", variety: "Geisha", process: "Washed", price: "‚Ç¨35.92 (¬•6,514)", priceJPY: 6514, weight: "100g", flavor: "Violet, Blackberry, Kiwi, Cherry", elevation: "1885-1900m", orderDate: "2026-02-13", url: "https://tanat.coffee/en/boutique/elida-aguacate-asd-b2d-2603/", image: "https://tanat.coffee/wp-content/uploads/2025/07/PAQUETWEBMICROLOT_Elida_AguacateEGW_100g.png", characterName: "", colorPalette: [], story: "" },
            { id: 28, name: "Finca Hartmann Great Reserve Geisha Natural Lot 53", roaster: "Tanat Coffee", origin: "Panama", region: "", variety: "Geisha", process: "Natural", price: "‚Ç¨42.56 (¬•7,718)", priceJPY: 7718, weight: "100g", flavor: "", elevation: "1900m", orderDate: "2026-02-13", url: "https://tanat.coffee/en/boutique/finca-hartmann-great-reserve-geisha-natural-53/", image: "https://tanat.coffee/wp-content/uploads/2025/11/PAQUETWEBMICROLOT_HARTMANNGR53.png", characterName: "", colorPalette: [], story: "" },
            { id: 29, name: "Finca Sophia GW2 Estaci√≥n", roaster: "Tanat Coffee", origin: "Panama", region: "", variety: "Geisha", process: "Washed", price: "‚Ç¨47.30 (¬•8,578)", priceJPY: 8578, weight: "60g", flavor: "Grapefruit, Peach, Jasmine, Chamomile", orderDate: "2026-02-13", url: "https://tanat.coffee/en/boutique/finca-sophia-gw2-estacion/", image: "https://tanat.coffee/wp-content/uploads/2026/01/PAQUETWEBMICROLOT_SophiaGW2.png", characterName: "", colorPalette: [], story: "" },
            { id: 30, name: 'Chilaka 240hr Natural', roaster: 'Rose Coffee', origin: 'Ethiopia', region: 'Chilaka, Sidama', farm: 'Chilaka Washing Station', producer: 'Tamiru Tadesse', variety: 'JARC 74158', process: '240hr Anaerobic Natural', elevation: '2400m', flavor: 'Strawberry, Grape, Sweet, Round, Rich Red Fruit', price: 'CHF 26.00 (¬•5,190)', priceJPY: 5190, weight: '200g', orderDate: '2026-02-09', orderNumber: '4312', url: 'https://rose-coffee.com/products/chilaka-240hr-natural', image: 'https://rose-coffee.com/cdn/shop/files/ChilakaFIL.png?v=1759589613', characterName: '', colorPalette: [], story: '' },
            { id: 31, name: 'El Jard√≠n Pink Bourbon Anaerobic Washed', roaster: 'Rose Coffee', origin: 'Colombia', region: 'Tolima', farm: 'Finca El Jardin', producer: 'Jorge El√≠as Rojas', variety: 'Pink Bourbon', process: 'Anaerobic Washed', elevation: '1850m', flavor: 'Pink Grapefruit, Orange, Jammy, Juicy, Bright Citrus', price: 'CHF 69.00 (¬•13,773)', priceJPY: 13773, weight: '1kg', orderDate: '2026-02-09', orderNumber: '4312', url: 'https://rose-coffee.com/products/el-jardin-pink-bourbon-anaerobic-washed', image: 'https://rose-coffee.com/cdn/shop/files/ElJardin.png?v=1763295798', characterName: '', colorPalette: [], story: '' },
            { id: 32, name: 'Corpachi Pacamara Anaerobic Natural', roaster: 'Rose Coffee', origin: 'Peru', region: '', farm: 'Corpachi Coffee Company', producer: '', variety: 'Pacamara', process: 'Anaerobic Natural (72hr Oxidation)', elevation: '1450m', flavor: 'Apricot, Grape, Raspberry, Tea Florals', price: 'CHF 25.00 (¬•4,990)', priceJPY: 4990, weight: '200g', orderDate: '2026-02-09', orderNumber: '4312', url: 'https://rose-coffee.com/products/corpachi-pacamara-supernatural', image: 'https://rose-coffee.com/cdn/shop/files/CorpachipacamaraPink.png?v=1764933002', characterName: '', colorPalette: [], story: '' },
            { id: 33, name: 'Hacienda La Esmeralda Geisha Washed', roaster: 'Rose Coffee', origin: 'Panama', region: 'Boquete', farm: 'Hacienda La Esmeralda', producer: 'Peterson Family', variety: 'Geisha', process: 'Washed', elevation: '1600-1950m', flavor: 'Jasmine, Orange Blossom, Black Tea, Peach, Lemonade', price: 'CHF 88.00 (¬•17,566)', priceJPY: 17566, weight: '200g', orderDate: '2026-01-19', orderNumber: '4197', url: 'https://rose-coffee.com/products/hacienda-la-esmeralda-geisha-washed', image: 'https://rose-coffee.com/cdn/shop/files/Esmewashed.png?v=1768059127', characterName: '', colorPalette: [], story: '' },
            { id: 34, name: 'Alo Special Hybrid Washed', roaster: 'Rose Coffee', origin: 'Ethiopia', region: 'Bensa, Sidama', farm: 'Alo Village', producer: 'Tamiru Tadesse', variety: 'JARC 74158', process: 'Hybrid Washed (72hr fermentation)', elevation: '2450m', flavor: 'Jasmine, Peach, Bergamot, Tea-like', price: 'CHF 16.00 (¬•3,194)', priceJPY: 3194, weight: '100g', orderDate: '2026-01-19', orderNumber: '4197', url: 'https://rose-coffee.com/products/alo-special-hybrid-washed', image: 'https://rose-coffee.com/cdn/shop/files/AloHWpink.png?v=1764930129', characterName: '', colorPalette: [], story: '' },
            { id: 35, name: 'Alo Classic Washed', roaster: 'Rose Coffee', origin: 'Ethiopia', region: 'Sidama', farm: 'Alo Washing Station', producer: 'Tamiru Tadesse', variety: 'JARC 74158', process: 'Classic Washed', elevation: '2400m', flavor: 'Jasmine, Peach, Citrus, Pink Pepper, Earl Grey Tea', price: 'CHF 20.00 (¬•3,992)', priceJPY: 3992, weight: '200g', orderDate: '2026-01-19', orderNumber: '4197', url: 'https://rose-coffee.com/products/alo-classic-washed', image: 'https://rose-coffee.com/cdn/shop/files/Alo_Washed.png?v=1759585320', characterName: '', colorPalette: [], story: '' },
            { id: 36, name: 'The Bedtime Blend (Decaf)', roaster: 'Rose Coffee', origin: 'Brazil / Mexico', region: '', farm: 'Blend', producer: '', variety: 'Mixed', process: 'Swiss Water + Mountain Water Decaf', elevation: '', flavor: 'Dark Chocolate, Roasted Nuts, Malty, Sweet, Spicy', price: 'CHF 13.00 (¬•2,595)', priceJPY: 2595, weight: '200g', orderDate: '2026-01-19', orderNumber: '4197', url: 'https://rose-coffee.com/products/the-bedtime-blend-2-0', image: 'https://rose-coffee.com/cdn/shop/files/BedtimeBlend.png?v=1759352469', characterName: '', colorPalette: [], story: '' },
            { id: 37, name: 'Alo Mosto Anaerobic Natural', roaster: 'Rose Coffee', origin: 'Ethiopia', region: 'Bensa, Sidama', farm: 'Alo Main Station', producer: 'Tamiru Tadesse', variety: 'JARC 74158', process: '96hr Anaerobic Natural with Mosto', elevation: '2400-2500m', flavor: 'Tropical Fruits, Grape, Bright, Sweet, Fermented', price: 'CHF 27.00 (¬•5,389)', priceJPY: 5389, weight: '200g', orderDate: '2026-01-19', orderNumber: '4197', url: 'https://rose-coffee.com/products/alo-mosto-anaerobic-natural', image: 'https://rose-coffee.com/cdn/shop/files/AloMostoFIL.png?v=1759586187', characterName: '', colorPalette: [], story: '' },
            { id: 38, name: 'El Paraiso Letty', roaster: 'Hatch Coffee', origin: 'Colombia', region: 'Cauca', farm: 'Finca El Paraiso', producer: 'Diego Samuel Bermudez', variety: 'Geisha', process: 'Double Anaerobic Thermal Shock Washed', elevation: '1930m', flavor: 'White Peach, Peach Gummies, Oolong, Pineapple, Caramel', price: 'CA$65.00 (¬•7,306)', priceJPY: 7306, weight: '200g', orderDate: '2026-02-07', orderNumber: '202767447532', url: 'https://www.hatchcrafted.com/shop/ep-letty', image: 'https://cdn.filestackcontent.com/security=p:eyJleHBpcnkiOjE3NzEyMDM1OTl9,s:3b33a9e02d4931cdffe7861981b66eeaf6b18e0f708c2b06f8664589eb26726f/resize=w:1000,h:1000,fit:max/output=format:jpg/quality=v:70/TInuY7jOTLyTO6RcUWLT', characterName: '', colorPalette: [], story: '' },
            { id: 39, name: 'Aroma Nativo CM412', roaster: 'Hatch Coffee', origin: 'Colombia', region: 'Huila', farm: 'Aroma Nativo', producer: 'Luis Marcelino', variety: 'Caturra Mejorado', process: 'Honey Lactic (Anaerobic + Lactic Bacteria)', elevation: '1600m', flavor: 'Shine Muscat, Pineapple, Mango, Panela', price: 'CA$50.00 (¬•5,620)', priceJPY: 5620, weight: '200g', orderDate: '2026-02-07', orderNumber: '202767447532', url: 'https://www.hatchcrafted.com/shop/aroma-nativo-cm412', image: 'https://cdn.filestackcontent.com/security=p:eyJleHBpcnkiOjE3NzEyMDM1OTl9,s:3b33a9e02d4931cdffe7861981b66eeaf6b18e0f708c2b06f8664589eb26726f/resize=w:1000,h:1000,fit:max/output=format:jpg/quality=v:70/FVD2BpumSsi9FSYurhR7', characterName: '', colorPalette: [], story: '' },
            { id: 40, name: 'El Paraiso Decaf Castillo', roaster: 'Hatch Coffee', origin: 'Colombia', region: 'Cauca', farm: 'Finca El Paraiso', producer: 'Diego Samuel Bermudez', variety: 'Castillo', process: 'Anaerobic Washed EA Decaf', elevation: '1930m', flavor: 'Strawberry, Cherry, Peach, Brown Sugar', price: 'CA$35.00 (¬•3,934)', priceJPY: 3934, weight: '200g', orderDate: '2026-02-07', orderNumber: '202767447532', url: 'https://www.hatchcrafted.com/shop/ep-decaf', image: 'https://cdn.filestackcontent.com/security=p:eyJleHBpcnkiOjE3NzEyMDM1OTl9,s:3b33a9e02d4931cdffe7861981b66eeaf6b18e0f708c2b06f8664589eb26726f/resize=w:1000,h:1000,fit:max/output=format:jpg/quality=v:70/1TjNE23tQOqYEB5GhwNr', characterName: '', colorPalette: [], story: '' },
            { id: 41, name: 'Alo Coffee Mosto Anaerobic Natural', roaster: 'Hatch Coffee', origin: 'Ethiopia', region: 'Bensa', farm: 'Alo Main Station', producer: 'Tamiru Tadesse', variety: '74158', process: 'Whole Cherry Anaerobic in Mosto', elevation: '', flavor: 'Shine Muscat, Pineapple, Mango, Panela', price: 'CA$42.00 (¬•4,721)', priceJPY: 4721, weight: '200g', orderDate: '2026-02-07', orderNumber: '202767447532', url: 'https://www.hatchcrafted.com/shop/alo-mosto-anaerobic-natural', image: 'https://cdn.filestackcontent.com/security=p:eyJleHBpcnkiOjE3NzEyMDM1OTl9,s:3b33a9e02d4931cdffe7861981b66eeaf6b18e0f708c2b06f8664589eb26726f/resize=w:1000,h:1000,fit:max/output=format:jpg/quality=v:70/yFgWGxBRQeauOwN1MrIc', characterName: '', colorPalette: [], story: '' },
            { id: 42, name: 'Bekele Anaerobic', roaster: 'Coffee Collective', origin: 'Ethiopia', region: 'Sidama, Murago', farm: 'Bekele Kachara Farm', producer: 'Bekele Mekonnen', variety: 'Kurume (74158)', process: 'Anaerobic Natural', elevation: '2350m', flavor: 'Grapes, Apples, Bergamot, Pineapple, Sweet & Fruity', price: 'DKK 140.00 (¬•3,412)', priceJPY: 3412, weight: '200g', orderDate: '2026-02-02', orderNumber: '15858', url: 'https://coffeecollective.dk/products/bekele-anaerobic-200g', image: 'https://coffeecollective.dk/cdn/shop/files/BekeleAnaerobic200gfront.png?v=1763023883', characterName: '', colorPalette: [], story: '' },
            { id: 43, name: 'Aga', roaster: 'Coffee Collective', origin: 'Ethiopia', region: 'Gedeb, Yirgacheffe', farm: 'Aga Washing Station', producer: 'Habtamu Fekadu Aga', variety: '74-158 Kurume', process: 'Washed (72-hour soaking)', elevation: '2100-2300m', flavor: 'Bergamot, Peach, Grapefruit, Light & Elegant', price: 'DKK 124.00 (¬•3,022)', priceJPY: 3022, weight: '250g', orderDate: '2026-02-02', orderNumber: '15858', url: 'https://coffeecollective.dk/products/aga-250g', image: 'https://coffeecollective.dk/cdn/shop/files/Aga_250_g_front_2.png?v=1753445262', characterName: '', colorPalette: [], story: '' },
            { id: 44, name: 'Jhoan', roaster: 'Coffee Collective', origin: 'Colombia', region: 'Huila, San Isidro', farm: 'Las Flores', producer: 'Jhoan & Diego Vergara', variety: 'Java', process: 'Thermal Shock Washed', elevation: '', flavor: 'Blackcurrant, Wine Gums, Apple, Sweet & Aromatic', price: 'DKK 217.00 (¬•5,288)', priceJPY: 5288, weight: '120g', orderDate: '2026-02-02', orderNumber: '15858', url: 'https://coffeecollective.dk/products/jhoan-120g', image: 'https://coffeecollective.dk/cdn/shop/files/Jhoan_120g_front.png?v=1769588864', characterName: '', colorPalette: [], story: '' },
            { id: 45, name: '„Ç®„É´„Çµ„É´„Éê„Éâ„É´ „Ç™„Çπ„Ç´„É´„Éª„Ç¢„ÇÆ„É©„É´ „Éä„ÉÅ„É•„É©„É´', roaster: 'IOLITE COFFEE ROASTERS', origin: 'El Salvador', region: 'Ahuachap√°n', farm: 'Oscar Aguilar Farm', producer: 'Oscar Aguilar', variety: '', process: 'Natural', elevation: '', flavor: 'Fruity, Chocolate, Clear', price: '¬•3,780', priceJPY: 3780, weight: '200g', orderDate: '2026-01-17', orderNumber: '9029108927', url: 'https://www.iolite-coffee.com/', image: '', characterName: '', colorPalette: [], story: '' },
            { id: 46, name: '„É´„ÉØ„É≥„ÉÄ „É¨„É°„É© „Ç¢„É≥„ÉÄ„Éº„Ç∑„Çß„Ç§„Éâ Lot 2', roaster: 'IOLITE COFFEE ROASTERS', origin: 'Rwanda', region: '', farm: '', producer: '', variety: '', process: '', elevation: '', flavor: 'Floral, Clean, Refreshing', price: '¬•2,160', priceJPY: 2160, weight: '200g', orderDate: '2026-01-17', orderNumber: '9029108927', url: 'https://www.iolite-coffee.com/', image: '', characterName: '', colorPalette: [], story: '' },
            { id: 49, name: 'Sangria Washed EL EDEN', roaster: 'TRUNK COFFEE', origin: 'Colombia', region: 'Palestina, Huila', farm: 'El Ed√©n', producer: 'Rodrigo Sanchez', variety: 'Purple Caturra / Bourbon', process: 'Washed Co-ferment (190hr)', elevation: '1500m', flavor: 'Cranberry, Raspberry, Pomegranate, Hibiscus, Rose Tea, Passion Fruit', price: '¬•2,300', priceJPY: 2300, weight: '100g', orderDate: '2026-02-14', orderNumber: '1127C5B76E48BC45', url: 'https://trunkcoffee.thebase.in/', image: '', characterName: '', colorPalette: [], story: '' },
            { id: 50, name: 'El Paraiso Lychee Lot Double Anaerobic Washed', roaster: 'TRUNK COFFEE', origin: 'Colombia', region: 'Piendam√≥, Cauca', farm: 'Finca El Paraiso', producer: 'Diego Samuel Bermudez', variety: 'Castillo', process: 'Double Anaerobic Washed', elevation: '', flavor: 'Strawberry Milk, Blueberry Jam, Lychee, Elegant Fragrance, Sweet Finish', price: '¬•3,000', priceJPY: 3000, weight: '100g', orderDate: '2026-02-14', orderNumber: '1127C5B76E48BC45', url: 'https://trunkcoffee.thebase.in/items/33504183', image: '', characterName: '', colorPalette: [], story: '' }
        ];

        let consideringBeans = [
            { id: 116, name: "Yusuf Natural", roaster: "Rose Coffee", origin: "Ethiopia", region: "Nensebo", variety: "JARC 74158", process: "Natural", price: "CHF 15", weight: "200g", flavor: "Tropical Fruits, Grape, Sweet, Round", elevation: "2400m", url: "https://rose-coffee.com/products/yusuf-natural", image: "https://rose-coffee.com/cdn/shop/files/YusufFIL.png", priority: "normal", notes: "" },
            { id: 117, name: "Jurutungo Geisha Natural", roaster: "Rose Coffee", origin: "Panama", region: "Renaissance", variety: "Geisha", process: "Anaerobic Natural", price: "CHF ~25", weight: "100g", flavor: "Complex, Fruity", elevation: "1900m", producer: "Pocho Gallardo", url: "https://rose-coffee.com/products/jurutungo-geisha-natural", image: "https://rose-coffee.com/cdn/shop/files/Jurutungo_FIL.png", priority: "normal", notes: "" },
            { id: 121, name: "Ponderosa Geisha Anaerobic Natural", roaster: "Rose Coffee", origin: "Panama", region: "Boquete", variety: "Geisha", process: "Anaerobic Natural", price: "CHF ~30", weight: "100g", flavor: "White Peach, Lemon Zest, Floral, Green Tea", elevation: "1300-1700m", orderDate: "2026-02-09", url: "https://rose-coffee.com/products/ponderosa-geisha-anaerobic-natural", image: "https://rose-coffee.com/cdn/shop/files/Ponderosa_6d68ee39-8998-443f-87ac-6ebc93600def.png", priority: "normal", notes: "" },
            { id: 123, name: "Mil Cumbres Geisha Washed", roaster: "Rose Coffee", origin: "Panama", region: "Volc√°n", variety: "Geisha", process: "Washed", price: "CHF ~30", weight: "100g", flavor: "White Grapefruit, Nectarine, Jasmine, Vanilla", elevation: "1600-2000m", producer: "Mario Fonseca", url: "https://rose-coffee.com/products/mil-cumbres-geisha-washed", image: "https://rose-coffee.com/cdn/shop/files/MilCumbres.png", priority: "normal", notes: "" },
            { id: 124, name: "Janson Natural Geisha 942", roaster: "Rose Coffee", origin: "Panama", region: "Volc√°n", variety: "Geisha", process: "Natural", price: "CHF ~28", weight: "100g", flavor: "Complex, Fruity", elevation: "1700m", producer: "Janson Family", url: "https://rose-coffee.com/products/janson-natural-geisha-942", image: "https://rose-coffee.com/cdn/shop/files/Janson_942Pink.png", priority: "normal", notes: "" },
            { id: 125, name: "Agr√≠cola Geisha Anaerobic Washed", roaster: "Rose Coffee", origin: "Panama", variety: "Geisha", process: "Anaerobic Washed", price: "CHF ~28", weight: "100g", flavor: "Complex, Clean, Floral", elevation: "", orderDate: "2026-02-09", url: "https://rose-coffee.com/products/agricola-geisha-anaerobic-washed", image: "https://rose-coffee.com/cdn/shop/files/Agricola.png", priority: "normal", notes: "" }
        ];

        let currentTab = 'purchased';
        let currentView = 'card';
        let editingBeanId = null;
        let editingTab = null;
        let selectedColors = [];
        let nextId = 151;

        // ===== UTILITY FUNCTIONS =====
        function getOriginColor(origin) {
            const colors = {
                'Colombia': '#ff9fb4',
                'Costa Rica': '#ff6b6b',
                'Ethiopia': '#7af2e0',
                'Guatemala': '#ffd700',
                'Panama': '#243668',
                'Peru': '#e8a87c',
                'El Salvador': '#d4a574',
                'Rwanda': '#85c1e9',
                'Brazil / Mexico': '#c39bd3'
            };
            return colors[origin] || '#c4b5fd';
        }

        function parsePriceToNumber(priceStr) {
            const num = parseFloat(priceStr.replace(/[^0-9.]/g, ''));
            return isNaN(num) ? 0 : num;
        }

        function filterAndSortBeans(beans) {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const filterOrigin = document.getElementById('filter-origin').value;
            const filterProcess = document.getElementById('filter-process').value;
            const sortBy = document.getElementById('sort-by').value;

            let filtered = beans.filter(bean => {
                const matchesSearch = !searchTerm || bean.name.toLowerCase().includes(searchTerm) ||
                                      bean.roaster.toLowerCase().includes(searchTerm) ||
                                      bean.origin.toLowerCase().includes(searchTerm);
                const matchesOrigin = !filterOrigin || bean.origin === filterOrigin;
                const matchesProcess = !filterProcess || (bean.process && bean.process.includes(filterProcess));
                return matchesSearch && matchesOrigin && matchesProcess;
            });

            filtered.sort((a, b) => {
                switch(sortBy) {
                    case 'price-low':
                        return (a.priceJPY || parsePriceToNumber(a.price)) - (b.priceJPY || parsePriceToNumber(b.price));
                    case 'price-high':
                        return (b.priceJPY || parsePriceToNumber(b.price)) - (a.priceJPY || parsePriceToNumber(a.price));
                    case 'origin':
                        return a.origin.localeCompare(b.origin);
                    case 'roaster':
                        return a.roaster.localeCompare(b.roaster) || a.name.localeCompare(b.name);
                    case 'freshness-peak': {
                        // Peak(È£≤„ÅøÈ†É)„ÅåËøë„ÅÑÈ†Ü: degassing ‚Üí peak ‚Üí good ‚Üí drink soon ‚Üí past prime
                        const order = { degassing: 1, peak: 2, good: 3, 'drink-soon': 4, 'past-prime': 5 };
                        const fa = getFreshnessInfo(a.orderDate);
                        const fb = getFreshnessInfo(b.orderDate);
                        const sa = fa ? (order[fa.status] || 99) : 99;
                        const sb = fb ? (order[fb.status] || 99) : 99;
                        return sa - sb;
                    }
                    case 'freshness-urgent': {
                        // ÊÄ•„ÅéÈ†Ü: past prime ‚Üí drink soon ‚Üí good ‚Üí peak ‚Üí degassing
                        const order = { 'past-prime': 1, 'drink-soon': 2, good: 3, peak: 4, degassing: 5 };
                        const fa = getFreshnessInfo(a.orderDate);
                        const fb = getFreshnessInfo(b.orderDate);
                        const sa = fa ? (order[fa.status] || 99) : 99;
                        const sb = fb ? (order[fb.status] || 99) : 99;
                        return sa - sb;
                    }
                    case 'date-new':
                        if (!a.orderDate && !b.orderDate) return 0;
                        if (!a.orderDate) return 1;
                        if (!b.orderDate) return -1;
                        return new Date(b.orderDate) - new Date(a.orderDate);
                    case 'date-old':
                        if (!a.orderDate && !b.orderDate) return 0;
                        if (!a.orderDate) return 1;
                        if (!b.orderDate) return -1;
                        return new Date(a.orderDate) - new Date(b.orderDate);
                    case 'name':
                    default:
                        return a.name.localeCompare(b.name);
                }
            });

            return filtered;
        }

        function updateStats() {
            const totalBeans = purchasedBeans.length + consideringBeans.length;
            const allBeans = [...purchasedBeans, ...consideringBeans];
            const origins = new Set(allBeans.map(b => b.origin)).size;
            const roasters = new Set(allBeans.map(b => b.roaster)).size;

            let totalPrice = 0;
            let priceCount = 0;
            purchasedBeans.forEach(bean => {
                const price = bean.priceJPY || parsePriceToNumber(bean.price);
                if (price > 0) {
                    totalPrice += price;
                    priceCount++;
                }
            });
            const avgPrice = priceCount > 0 ? Math.round(totalPrice / priceCount) : 0;

            document.getElementById('stat-total-beans').textContent = totalBeans;
            document.getElementById('stat-origins').textContent = origins;
            document.getElementById('stat-roasters').textContent = roasters;
            document.getElementById('stat-avg-price').textContent = '¬•' + avgPrice.toLocaleString();

            document.getElementById('purchased-count').textContent = purchasedBeans.length;
            document.getElementById('considering-count').textContent = consideringBeans.length;
        }


        // ===== CARD CLICK HANDLER =====
        function handleCardClick(event, url) {
            // Don't open detail if clicking on buttons, links, or interactive elements
            const target = event.target;
            if (target.closest('.bean-card-action-btn') ||
                target.closest('.bean-card-actions') ||
                target.tagName === 'A' ||
                target.tagName === 'BUTTON') {
                return;
            }
            // Get bean id from card
            const card = target.closest('.bean-card');
            if (!card) return;
            const id = parseInt(card.dataset.id);
            openDetailModal(id);
        }

        function openDetailModal(id) {
            // Find bean in purchased or considering
            let bean = purchasedBeans.find(b => b.id === id);
            let isPurchased = true;
            if (!bean) {
                bean = consideringBeans.find(b => b.id === id);
                isPurchased = false;
            }
            if (!bean) return;

            const accentColor = getOriginColor(bean.origin);
            const flavorArray = bean.flavor ? bean.flavor.split(',').map(f => f.trim()) : [];
            const freshnessHTML = bean.orderDate ? renderFreshnessIndicator(bean.orderDate) : '';

            let html = '';

            // Hero image
            if (bean.image) {
                html += `<div class="detail-hero">
                    <img src="${bean.image}" alt="${bean.name}" onerror="this.parentElement.innerHTML='<div class=\\'detail-hero-placeholder\\'>‚òï</div>'">
                    <div class="detail-hero-accent" style="background: ${accentColor};"></div>
                </div>`;
            } else {
                html += `<div class="detail-hero">
                    <div class="detail-hero-placeholder">‚òï</div>
                    <div class="detail-hero-accent" style="background: ${accentColor};"></div>
                </div>`;
            }

            html += '<div class="detail-body">';

            // Name & roaster
            html += `<div class="detail-name">${bean.name}</div>`;
            html += `<div class="detail-roaster">${bean.roaster}</div>`;

            // Flavor pills
            if (flavorArray.length > 0) {
                html += '<div class="detail-flavors">';
                flavorArray.forEach(f => {
                    html += `<span class="detail-flavor-pill">${f}</span>`;
                });
                html += '</div>';
            }

            // Price + weight row
            html += `<div class="detail-price-row">
                <span class="detail-price">${bean.price}</span>
                <span class="detail-weight">${bean.weight || ''}</span>
            </div>`;

            // Freshness indicator
            if (freshnessHTML) {
                html += freshnessHTML;
            }

            // Info grid
            html += '<div class="detail-grid">';

            if (bean.origin) {
                html += `<div class="detail-field">
                    <div class="detail-field-label">Origin</div>
                    <div class="detail-field-value">üåç ${bean.origin}</div>
                </div>`;
            }
            if (bean.region) {
                html += `<div class="detail-field">
                    <div class="detail-field-label">Region</div>
                    <div class="detail-field-value">${bean.region}</div>
                </div>`;
            }
            if (bean.farm) {
                html += `<div class="detail-field">
                    <div class="detail-field-label">Farm</div>
                    <div class="detail-field-value">${bean.farm}</div>
                </div>`;
            }
            if (bean.producer) {
                html += `<div class="detail-field">
                    <div class="detail-field-label">Producer</div>
                    <div class="detail-field-value">${bean.producer}</div>
                </div>`;
            }
            if (bean.variety) {
                html += `<div class="detail-field">
                    <div class="detail-field-label">Variety</div>
                    <div class="detail-field-value">${bean.variety}</div>
                </div>`;
            }
            if (bean.process) {
                html += `<div class="detail-field">
                    <div class="detail-field-label">Process</div>
                    <div class="detail-field-value">${bean.process}</div>
                </div>`;
            }
            if (bean.elevation) {
                html += `<div class="detail-field">
                    <div class="detail-field-label">Elevation</div>
                    <div class="detail-field-value">‚õ∞Ô∏è ${bean.elevation}</div>
                </div>`;
            }
            if (bean.orderDate) {
                const d = new Date(bean.orderDate);
                const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                html += `<div class="detail-field">
                    <div class="detail-field-label">Purchased</div>
                    <div class="detail-field-value">üìÖ ${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}</div>
                </div>`;
            }

            // Character info (purchased only)
            if (isPurchased && bean.characterName) {
                html += `<div class="detail-field detail-field-wide">
                    <div class="detail-field-label">Character</div>
                    <div class="detail-field-value">üë§ ${bean.characterName}</div>
                </div>`;
            }
            if (isPurchased && bean.story) {
                html += `<div class="detail-field detail-field-wide">
                    <div class="detail-field-label">Story</div>
                    <div class="detail-field-value">${bean.story}</div>
                </div>`;
            }

            html += '</div>'; // end detail-grid

            // Action buttons
            html += '<div class="detail-actions">';
            if (bean.url) {
                html += `<a href="${bean.url}" target="_blank" class="detail-action-btn detail-action-primary">üìñ ÂïÜÂìÅ„Éö„Éº„Ç∏„ÇíË¶ã„Çã</a>`;
            }
            html += `<button class="detail-action-btn detail-action-secondary" onclick="closeDetailModal(); openEditModal(${bean.id}, '${isPurchased ? 'purchased' : 'considering'}')">‚úé Á∑®ÈõÜ</button>`;
            html += '</div>';

            html += '</div>'; // end detail-body

            document.getElementById('detail-content').innerHTML = html;
            document.getElementById('detail-modal').classList.add('active');
        }

        function closeDetailModal() {
            document.getElementById('detail-modal').classList.remove('active');
        }

        document.getElementById('detail-modal-close').addEventListener('click', closeDetailModal);
        document.getElementById('detail-modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('detail-modal')) {
                closeDetailModal();
            }
        });

        // ===== FRESHNESS INDICATOR =====
        function getFreshnessInfo(orderDate) {
            if (!orderDate) return null;

            const purchased = new Date(orderDate);
            const now = new Date();
            const daysSince = Math.floor((now - purchased) / (1000 * 60 * 60 * 24));

            let status, statusText, cssClass, barPercent;

            if (daysSince <= 5) {
                status = 'degassing';
                statusText = 'Degassing';
                cssClass = 'freshness-degassing';
                barPercent = 100;
            } else if (daysSince <= 21) {
                status = 'peak';
                statusText = 'Peak';
                cssClass = 'freshness-peak';
                barPercent = 100 - ((daysSince - 5) / 16 * 15); // 100% ‚Üí 85%
            } else if (daysSince <= 42) {
                status = 'good';
                statusText = 'Good';
                cssClass = 'freshness-good';
                barPercent = 85 - ((daysSince - 21) / 21 * 35); // 85% ‚Üí 50%
            } else if (daysSince <= 60) {
                status = 'soon';
                statusText = 'Drink Soon';
                cssClass = 'freshness-soon';
                barPercent = 50 - ((daysSince - 42) / 18 * 30); // 50% ‚Üí 20%
            } else {
                status = 'past';
                statusText = 'Past Prime';
                cssClass = 'freshness-past';
                barPercent = Math.max(5, 20 - ((daysSince - 60) / 30 * 15));
            }

            // Format date nicely
            const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            const dateStr = purchased.getDate() + ' ' + months[purchased.getMonth()] + ' ' + purchased.getFullYear();

            // Calculate drink-by date (roughly 6 weeks from purchase)
            const drinkBy = new Date(purchased);
            drinkBy.setDate(drinkBy.getDate() + 42);
            const drinkByStr = drinkBy.getDate() + ' ' + months[drinkBy.getMonth()];

            return {
                daysSince,
                status,
                statusText,
                cssClass,
                barPercent: Math.round(barPercent),
                dateStr,
                drinkByStr
            };
        }

        function renderFreshnessIndicator(orderDate) {
            const info = getFreshnessInfo(orderDate);
            if (!info) return '';

            return `
                <div class="bean-freshness ${info.cssClass}">
                    <div class="bean-freshness-header">
                        <span class="bean-freshness-date">üìÖ ${info.dateStr} (${info.daysSince}Êó•Ââç)</span>
                        <span class="bean-freshness-status">${info.statusText}</span>
                    </div>
                    <div class="bean-freshness-bar">
                        <div class="bean-freshness-bar-fill" style="width: ${info.barPercent}%"></div>
                    </div>
                    <div class="bean-freshness-timeline">
                        <span>Ë≥ºÂÖ•</span>
                        <span>È£≤„ÅøÈ†É „Äú${info.drinkByStr}</span>
                    </div>
                </div>
            `;
        }

        // ===== RENDER FUNCTIONS =====
        function renderBeanCard(bean, isConsidering = false) {
            const flavorArray = bean.flavor ? bean.flavor.split(',').map(f => f.trim()) : [];
            const accentColor = getOriginColor(bean.origin);

            let cardHTML;
            const cardUrl = bean.url ? bean.url.replace(/'/g, "\\'") : '';
            if (bean.image) {
                cardHTML = `<div class="bean-card" data-id="${bean.id}" data-url="${bean.url || ''}" onclick="handleCardClick(event, '${cardUrl}')">
                    <div class="bean-card-thumb"><img src="${bean.image}" alt="${bean.name}" loading="lazy" onerror="this.parentElement.innerHTML='<div class=\\'bean-card-thumb-placeholder\\'>‚òï</div>'"></div>
                    <div class="bean-card-accent" style="background-color: ${accentColor};"></div>
                    <div class="bean-card-content">`;
            } else {
                cardHTML = `<div class="bean-card" data-id="${bean.id}" data-url="${bean.url || ''}" onclick="handleCardClick(event, '${cardUrl}')">
                    <div class="bean-card-thumb-placeholder">‚òï</div>
                    <div class="bean-card-accent" style="background-color: ${accentColor};"></div>
                    <div class="bean-card-content">`;
            }

            cardHTML += `
                        <div class="bean-card-header">
                            <div class="bean-card-name">${bean.name}</div>
                            <div class="bean-card-actions">
                                ${!isConsidering ? `<button class="bean-card-action-btn" onclick="openCharacterModal(${bean.id})" title="„Ç≠„É£„É©„ÇØ„Çø„Éº">üé®</button>` : ''}
                                <button class="bean-card-action-btn" onclick="openEditModal(${bean.id}, '${currentTab}')" title="Á∑®ÈõÜ">‚úé</button>
                                <button class="bean-card-action-btn" onclick="deleteBean(${bean.id}, '${currentTab}')" title="ÂâäÈô§">üóë</button>
                            </div>
                        </div>
                        <div class="bean-card-meta">
                            <span class="bean-card-origin">üåç ${bean.origin}</span>
                            <span>${bean.roaster}</span>
                        </div>
            `;

            if (flavorArray.length > 0) {
                cardHTML += '<div class="bean-card-flavor">';
                flavorArray.slice(0, 3).forEach(flavor => {
                    cardHTML += `<div class="flavor-pill">${flavor}</div>`;
                });
                cardHTML += '</div>';
            }

            cardHTML += `
                        <div class="bean-card-price">${bean.price}</div>
                        ${!isConsidering && bean.orderDate ? renderFreshnessIndicator(bean.orderDate) : ''}
                        <div class="bean-card-url">
                            <a href="${bean.url}" target="_blank">üìñ Ë©≥Á¥∞„ÇíË¶ã„Çã</a>
                        </div>
            `;

            if (!isConsidering && bean.characterName) {
                cardHTML += `<div class="bean-card-meta" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e8e8e8;">üë§ ${bean.characterName}</div>`;
            }

            if (isConsidering && bean.priority === 'high') {
                cardHTML += `<div class="bean-card-meta" style="margin-top: 10px;">‚≠ê ÂÑ™ÂÖàÂ∫¶È´ò</div>`;
            }

            cardHTML += '</div></div>';
            return cardHTML;
        }

        function renderPurchasedCards() {
            const container = document.getElementById('purchased-view-card');
            const filtered = filterAndSortBeans(purchasedBeans);

            if (filtered.length === 0) {
                container.innerHTML = '';
                document.getElementById('purchased-empty').classList.remove('hidden');
            } else {
                document.getElementById('purchased-empty').classList.add('hidden');
                container.innerHTML = filtered.map(bean => renderBeanCard(bean, false)).join('');
            }
        }

        function renderConsideringCards() {
            const container = document.getElementById('considering-view-card');
            const filtered = filterAndSortBeans(consideringBeans);

            if (filtered.length === 0) {
                container.innerHTML = '';
                document.getElementById('considering-empty').classList.remove('hidden');
                return;
            }

            document.getElementById('considering-empty').classList.add('hidden');

            const grouped = {};
            filtered.forEach(bean => {
                if (!grouped[bean.roaster]) {
                    grouped[bean.roaster] = [];
                }
                grouped[bean.roaster].push(bean);
            });

            let html = '';
            Object.keys(grouped).sort().forEach(roaster => {
                const beans = grouped[roaster];
                const totalCost = beans.reduce((sum, b) => sum + parsePriceToNumber(b.price), 0);

                html += `
                    <div class="roaster-group">
                        <div class="roaster-header" onclick="toggleRoasterGroup(this)">
                            <div class="roaster-info">
                                <div class="roaster-name">${roaster}</div>
                                <div class="roaster-meta">${beans.length} Ë±Ü ‚Ä¢ ÂêàË®à ‚Ç¨${totalCost.toFixed(2)}</div>
                            </div>
                            <div class="roaster-toggle">‚ñ∂</div>
                        </div>
                        <div class="roaster-content">
                            ${beans.map(bean => renderBeanCard(bean, true)).join('')}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function renderPurchasedTable() {
            const tbody = document.querySelector('#purchased-table tbody');
            const filtered = filterAndSortBeans(purchasedBeans);

            if (filtered.length === 0) {
                tbody.innerHTML = '';
                document.getElementById('purchased-empty').classList.remove('hidden');
                return;
            }

            document.getElementById('purchased-empty').classList.add('hidden');

            tbody.innerHTML = filtered.map(bean => `
                <tr>
                    <td>${bean.name}</td>
                    <td>${bean.roaster}</td>
                    <td>${bean.origin}</td>
                    <td>${bean.process}</td>
                    <td>${bean.price}</td>
                    <td>${bean.orderDate || '‚Äî'}</td>
                    <td>
                        <button class="bean-card-action-btn" onclick="openEditModal(${bean.id}, 'purchased')">‚úé</button>
                        <button class="bean-card-action-btn" onclick="deleteBean(${bean.id}, 'purchased')">üóë</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderConsideringTable() {
            const tbody = document.querySelector('#considering-table tbody');
            const filtered = filterAndSortBeans(consideringBeans);

            if (filtered.length === 0) {
                tbody.innerHTML = '';
                document.getElementById('considering-empty').classList.remove('hidden');
                return;
            }

            document.getElementById('considering-empty').classList.add('hidden');

            tbody.innerHTML = filtered.map(bean => `
                <tr>
                    <td>${bean.name}</td>
                    <td>${bean.roaster}</td>
                    <td>${bean.origin}</td>
                    <td>${bean.process}</td>
                    <td>${bean.price}</td>
                    <td>${bean.priority === 'high' ? '‚≠ê È´ò' : 'ÈÄöÂ∏∏'}</td>
                    <td>
                        <button class="bean-card-action-btn" onclick="openEditModal(${bean.id}, 'considering')">‚úé</button>
                        <button class="bean-card-action-btn" onclick="deleteBean(${bean.id}, 'considering')">üóë</button>
                    </td>
                </tr>
            `).join('');
        }

        function render() {
            if (currentTab === 'purchased') {
                if (currentView === 'card') {
                    renderPurchasedCards();
                    document.getElementById('purchased-view-card').classList.remove('hidden');
                    document.getElementById('purchased-view-table').classList.add('hidden');
                } else {
                    renderPurchasedTable();
                    document.getElementById('purchased-view-card').classList.add('hidden');
                    document.getElementById('purchased-view-table').classList.remove('hidden');
                }
            } else {
                if (currentView === 'card') {
                    renderConsideringCards();
                    document.getElementById('considering-view-card').classList.remove('hidden');
                    document.getElementById('considering-view-table').classList.add('hidden');
                } else {
                    renderConsideringTable();
                    document.getElementById('considering-view-card').classList.add('hidden');
                    document.getElementById('considering-view-table').classList.remove('hidden');
                }
            }
            updateStats();
        }



        // ===== ANALYTICS DASHBOARD =====
        const POPX_COLORS = [
            '#ff9fb4', '#7af2e0', '#243668', '#ffd700', '#ff6b6b',
            '#c4b5fd', '#98d8c8', '#fbbf24', '#e8a87c', '#85c1e9',
            '#d4a574', '#c39bd3', '#a3d977', '#f0a8d0', '#87ceeb'
        ];

        function renderAnalytics() {
            // Destroy existing charts
            Chart.helpers.each(Chart.instances, (instance) => { instance.destroy(); });

            renderOriginChart();
            renderProcessChart();
            renderFlavorChart();
            renderFreshnessChart();
            renderSpendingChart();
            renderPurchaseRecommendation();
            renderCafePricing();
        }

        // --- Origin Distribution ---
        function renderOriginChart() {
            const counts = {};
            purchasedBeans.forEach(b => {
                const o = b.origin || 'Unknown';
                counts[o] = (counts[o] || 0) + 1;
            });
            const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);

            new Chart(document.getElementById('chart-origin'), {
                type: 'doughnut',
                data: {
                    labels: sorted.map(s => s[0]),
                    datasets: [{
                        data: sorted.map(s => s[1]),
                        backgroundColor: POPX_COLORS.slice(0, sorted.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { family: "'Montserrat', sans-serif", size: 11 },
                                padding: 12,
                                usePointStyle: true,
                                pointStyleWidth: 8
                            }
                        }
                    }
                }
            });
        }

        // --- Process Distribution ---
        function renderProcessChart() {
            const counts = {};
            purchasedBeans.forEach(b => {
                let p = b.process || 'Unknown';
                // Simplify long process names
                if (p.toLowerCase().includes('anaerobic') && p.toLowerCase().includes('natural')) p = 'Anaerobic Natural';
                else if (p.toLowerCase().includes('anaerobic') && p.toLowerCase().includes('washed')) p = 'Anaerobic Washed';
                else if (p.toLowerCase().includes('thermal shock')) p = 'Thermal Shock';
                else if (p.toLowerCase().includes('honey')) p = 'Honey';
                else if (p.toLowerCase().includes('natural') && !p.toLowerCase().includes('anaerobic')) p = 'Natural';
                else if (p.toLowerCase().includes('washed') && !p.toLowerCase().includes('anaerobic')) p = 'Washed';
                else if (p.toLowerCase().includes('lactic')) p = 'Lactic';
                else if (p.length > 25) p = p.substring(0, 22) + '...';
                counts[p] = (counts[p] || 0) + 1;
            });
            const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);

            new Chart(document.getElementById('chart-process'), {
                type: 'doughnut',
                data: {
                    labels: sorted.map(s => s[0]),
                    datasets: [{
                        data: sorted.map(s => s[1]),
                        backgroundColor: POPX_COLORS.slice(0, sorted.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { family: "'Montserrat', sans-serif", size: 11 },
                                padding: 12,
                                usePointStyle: true,
                                pointStyleWidth: 8
                            }
                        }
                    }
                }
            });
        }

        // --- Flavor Distribution ---
        function renderFlavorChart() {
            const counts = {};
            purchasedBeans.forEach(b => {
                if (!b.flavor) return;
                b.flavor.split(',').forEach(f => {
                    const flavor = f.trim().toLowerCase();
                    // Normalize similar flavors
                    let normalized = flavor;
                    if (flavor.includes('peach')) normalized = 'Peach';
                    else if (flavor.includes('jasmine')) normalized = 'Jasmine';
                    else if (flavor.includes('strawberry')) normalized = 'Strawberry';
                    else if (flavor.includes('grape') || flavor.includes('muscat')) normalized = 'Grape / Muscat';
                    else if (flavor.includes('pineapple')) normalized = 'Pineapple';
                    else if (flavor.includes('bergamot')) normalized = 'Bergamot';
                    else if (flavor.includes('rose')) normalized = 'Rose / Floral';
                    else if (flavor.includes('floral') || flavor.includes('flower')) normalized = 'Rose / Floral';
                    else if (flavor.includes('chocolate')) normalized = 'Chocolate';
                    else if (flavor.includes('citrus') || flavor.includes('lemon') || flavor.includes('grapefruit') || flavor.includes('orange')) normalized = 'Citrus';
                    else if (flavor.includes('berry') || flavor.includes('blueberry') || flavor.includes('raspberry') || flavor.includes('cranberry')) normalized = 'Berry';
                    else if (flavor.includes('tropical') || flavor.includes('mango') || flavor.includes('passion')) normalized = 'Tropical';
                    else if (flavor.includes('caramel') || flavor.includes('honey') || flavor.includes('sugar') || flavor.includes('panela') || flavor.includes('sweet')) normalized = 'Caramel / Sweet';
                    else if (flavor.includes('tea') || flavor.includes('oolong') || flavor.includes('earl grey')) normalized = 'Tea';
                    else if (flavor.includes('wine') || flavor.includes('sangria')) normalized = 'Wine';
                    else if (flavor.includes('plum') || flavor.includes('apricot')) normalized = 'Stone Fruit';
                    else if (flavor.includes('nut') || flavor.includes('almond')) normalized = 'Nutty';
                    else if (flavor.includes('lychee')) normalized = 'Lychee';
                    else if (flavor.includes('lavender') || flavor.includes('hibiscus')) normalized = 'Lavender / Hibiscus';
                    else normalized = f.trim(); // keep original if can't normalize

                    // Skip very generic terms
                    if (['sweet', 'round', 'clear', 'rich', 'bright', 'light', 'juicy', 'clean', 'refreshing', 'elegant', 'aromatic'].includes(flavor)) return;

                    counts[normalized] = (counts[normalized] || 0) + 1;
                });
            });
            const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 15);

            new Chart(document.getElementById('chart-flavor'), {
                type: 'bar',
                data: {
                    labels: sorted.map(s => s[0]),
                    datasets: [{
                        data: sorted.map(s => s[1]),
                        backgroundColor: sorted.map((_, i) => {
                            const t = i / sorted.length;
                            return `rgba(${Math.round(255 - t*13)}, ${Math.round(159 + t*83)}, ${Math.round(180 + t*44)}, 0.8)`;
                        }),
                        borderRadius: 6,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { stepSize: 1, font: { family: "'Montserrat', sans-serif", size: 11 } }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { font: { family: "'Noto Sans JP', sans-serif", size: 11 } }
                        }
                    }
                }
            });
        }

        // --- Freshness Distribution ---
        function renderFreshnessChart() {
            const buckets = { 'Degassing\n(0-5Êó•)': 0, 'Peak\n(5-21Êó•)': 0, 'Good\n(21-42Êó•)': 0, 'Drink Soon\n(42-60Êó•)': 0, 'Past Prime\n(60Êó•+)': 0, 'No Date': 0 };
            const colors = ['#7af2e0', '#059669', '#fbbf24', '#ff9fb4', '#d1d5db', '#e8e8e8'];

            purchasedBeans.forEach(b => {
                if (!b.orderDate) { buckets['No Date']++; return; }
                const days = Math.floor((new Date() - new Date(b.orderDate)) / 86400000);
                if (days <= 5) buckets['Degassing\n(0-5Êó•)']++;
                else if (days <= 21) buckets['Peak\n(5-21Êó•)']++;
                else if (days <= 42) buckets['Good\n(21-42Êó•)']++;
                else if (days <= 60) buckets['Drink Soon\n(42-60Êó•)']++;
                else buckets['Past Prime\n(60Êó•+)']++;
            });

            // Remove empty buckets
            const entries = Object.entries(buckets).filter(e => e[1] > 0);
            const filteredColors = Object.keys(buckets).map((k, i) => [k, colors[i]]).filter(([k]) => buckets[k] > 0).map(e => e[1]);

            new Chart(document.getElementById('chart-freshness'), {
                type: 'bar',
                data: {
                    labels: entries.map(e => e[0]),
                    datasets: [{
                        data: entries.map(e => e[1]),
                        backgroundColor: filteredColors,
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1, font: { family: "'Montserrat', sans-serif", size: 11 } },
                            grid: { color: 'rgba(0,0,0,0.04)' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { font: { family: "'Noto Sans JP', sans-serif", size: 10 }, maxRotation: 0 }
                        }
                    }
                }
            });
        }

        // --- Monthly Spending ---
        function renderSpendingChart() {
            const monthly = {};
            purchasedBeans.forEach(b => {
                if (!b.orderDate || !b.priceJPY) return;
                const d = new Date(b.orderDate);
                const key = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
                monthly[key] = (monthly[key] || 0) + b.priceJPY;
            });

            const sorted = Object.entries(monthly).sort((a, b) => a[0].localeCompare(b[0]));
            const labels = sorted.map(s => {
                const [y, m] = s[0].split('-');
                return m + 'Êúà';
            });

            new Chart(document.getElementById('chart-spending'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ÊîØÂá∫ (¬•)',
                        data: sorted.map(s => s[1]),
                        backgroundColor: 'rgba(255, 159, 180, 0.6)',
                        borderColor: '#ff9fb4',
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => '¬•' + ctx.parsed.y.toLocaleString()
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (v) => '¬•' + (v / 1000).toFixed(0) + 'k',
                                font: { family: "'Montserrat', sans-serif", size: 11 }
                            },
                            grid: { color: 'rgba(0,0,0,0.04)' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { font: { family: "'Noto Sans JP', sans-serif", size: 12 } }
                        }
                    }
                }
            });
        }

        // --- Purchase Recommendation ---
        function renderPurchaseRecommendation() {
            const now = new Date();
            let peakCount = 0, goodCount = 0, soonCount = 0, pastCount = 0, degasCount = 0;
            let earliestPastPrime = Infinity;

            purchasedBeans.forEach(b => {
                if (!b.orderDate) return;
                const days = Math.floor((now - new Date(b.orderDate)) / 86400000);
                if (days <= 5) degasCount++;
                else if (days <= 21) peakCount++;
                else if (days <= 42) goodCount++;
                else if (days <= 60) { soonCount++; }
                else pastCount++;

                // Find when next bean hits "drink soon" (42 days from purchase)
                const daysUntilSoon = 42 - days;
                if (daysUntilSoon > 0 && daysUntilSoon < earliestPastPrime) {
                    earliestPastPrime = daysUntilSoon;
                }
            });

            // Calculate "next order" timing
            // When most peak beans transition to "good", it's time to order
            const activeBeans = peakCount + goodCount + degasCount;
            let urgency, urgencyColor, daysUntilOrder;

            if (activeBeans <= 5) {
                urgency = '‰ªä„Åô„ÅêÊ≥®ÊñáÔºÅ';
                urgencyColor = '#dc2626';
                daysUntilOrder = 0;
            } else if (soonCount > peakCount) {
                urgency = '„Åù„Çç„Åù„ÇçÊ≥®Êñá';
                urgencyColor = '#f59e0b';
                daysUntilOrder = 3;
            } else {
                daysUntilOrder = Math.max(0, earliestPastPrime - 7); // order 7 days before
                if (daysUntilOrder <= 7) {
                    urgency = '„Åù„Çç„Åù„ÇçÊ≥®Êñá';
                    urgencyColor = '#f59e0b';
                } else {
                    urgency = '„Åæ„Å†Â§ß‰∏àÂ§´';
                    urgencyColor = '#059669';
                }
            }

            // Analyze what flavors/varieties are missing or underrepresented
            const flavorCounts = {};
            const varietyCounts = {};
            const originCounts = {};
            purchasedBeans.forEach(b => {
                if (b.variety) varietyCounts[b.variety] = (varietyCounts[b.variety] || 0) + 1;
                if (b.origin) originCounts[b.origin] = (originCounts[b.origin] || 0) + 1;
                if (b.flavor) {
                    b.flavor.split(',').forEach(f => {
                        const fl = f.trim();
                        if (fl) flavorCounts[fl] = (flavorCounts[fl] || 0) + 1;
                    });
                }
            });

            // Find less explored areas
            const topVarieties = Object.entries(varietyCounts).sort((a,b) => b[1]-a[1]);
            const dominantVariety = topVarieties[0] ? topVarieties[0][0] : 'Geisha';
            const underrepresented = ['Typica', 'SL34', 'Pacamara', 'Tabi', 'Caturra', 'Java', 'Laurina'].filter(v => !varietyCounts[v] || varietyCounts[v] <= 1);

            const topOrigins = Object.entries(originCounts).sort((a,b) => b[1]-a[1]);
            const underrepOrigins = ['Kenya', 'Yemen', 'Indonesia', 'Hawaii', 'Mexico', 'Bolivia'].filter(o => !originCounts[o]);

            let recHTML = '<div class="purchase-rec">';

            // Timing section
            recHTML += `<div class="purchase-timing">
                <div class="purchase-timing-days">${daysUntilOrder}</div>
                <div class="purchase-timing-label">Êó•Âæå„ÅåÊ¨°„ÅÆÊ≥®Êñá„Çø„Ç§„Éü„É≥„Ç∞</div>
                <div class="purchase-timing-status" style="background: ${urgencyColor}20; color: ${urgencyColor};">${urgency}</div>
                <div style="margin-top: 16px; font-size: 12px; color: #666;">
                    Peak: ${peakCount}Ë±Ü / Good: ${goodCount}Ë±Ü<br>
                    Drink Soon: ${soonCount}Ë±Ü / Past: ${pastCount}Ë±Ü
                </div>
            </div>`;

            // Suggestions
            recHTML += '<div class="purchase-rec-suggestions">';

            // Variety suggestion
            if (underrepresented.length > 0) {
                recHTML += `<div class="purchase-rec-item">
                    <span class="purchase-rec-icon">üå±</span>
                    <div class="purchase-rec-text">
                        <strong>ÂìÅÁ®Æ„ÅÆÂ§öÊßòÂåñ:</strong> ${dominantVariety}„ÅåÂ§ö„ÇÅ„ÄÇ
                        <strong>${underrepresented.slice(0,3).join(', ')}</strong> „ÅÇ„Åü„Çä„ÇíË©¶„Åó„Å¶„Åø„Çã„Å®Êñ∞„Åó„ÅÑÁô∫Ë¶ã„Åå„ÅÇ„Çã„Åã„ÇÇÔºÅ
                    </div>
                </div>`;
            }

            // Origin suggestion
            if (underrepOrigins.length > 0) {
                recHTML += `<div class="purchase-rec-item">
                    <span class="purchase-rec-icon">üåç</span>
                    <div class="purchase-rec-text">
                        <strong>Áî£Âú∞„ÅÆÈñãÊãì:</strong> „Åæ„Å†Ë©¶„Åó„Å¶„ÅÑ„Å™„ÅÑ
                        <strong>${underrepOrigins.slice(0,3).join(', ')}</strong> „ÅÆË±Ü„Å´ÊåëÊà¶„Åó„Å¶„Åø„Å¶„ÅØÔºü
                    </div>
                </div>`;
            }

            // Flavor suggestion based on what's popular
            const flavorSorted = Object.entries(flavorCounts).sort((a,b) => b[1]-a[1]);
            const topFlavors = flavorSorted.slice(0, 3).map(f => f[0]);
            const missingFlavors = ['Chocolate', 'Nutty', 'Whiskey', 'Cinnamon', 'Vanilla', 'Maple'].filter(f =>
                !flavorSorted.some(([name]) => name.toLowerCase().includes(f.toLowerCase()))
            );

            if (missingFlavors.length > 0) {
                recHTML += `<div class="purchase-rec-item">
                    <span class="purchase-rec-icon">üëÖ</span>
                    <div class="purchase-rec-text">
                        <strong>„Éï„É¨„Éº„Éê„Éº„ÅÆÂπÖ:</strong> ${topFlavors.join(', ')} Á≥ª„ÅåÂ§ö„ÇÅ„ÄÇ
                        <strong>${missingFlavors.slice(0,3).join(', ')}</strong> Á≥ª„ÅÆ„Éï„É¨„Éº„Éê„Éº„ÇÇÈù¢ÁôΩ„ÅÑ„Åã„ÇÇÔºÅ
                    </div>
                </div>`;
            }

            // Decaf suggestion
            const decafCount = purchasedBeans.filter(b =>
                (b.process && b.process.toLowerCase().includes('decaf')) ||
                (b.name && b.name.toLowerCase().includes('decaf'))
            ).length;
            if (decafCount <= 2) {
                recHTML += `<div class="purchase-rec-item">
                    <span class="purchase-rec-icon">üåô</span>
                    <div class="purchase-rec-text">
                        <strong>„Éá„Ç´„Éï„Çß:</strong> ÁèæÂú®${decafCount}Á®Æ„ÅÆ„Åø„ÄÇÂ§úÁî®„ÇÑ„Ç´„Éï„Çß„Ç§„É≥Êéß„Åà„ÇÅ„Éã„Éº„Ç∫„Å´„ÄÅ„ÇÇ„ÅÜÂ∞ë„Åó„Éá„Ç´„Éï„Çß„ÅÆÈÅ∏ÊäûËÇ¢„Åå„ÅÇ„Çã„Å®‚óé
                    </div>
                </div>`;
            }

            recHTML += '</div></div>';

            document.getElementById('purchase-recommendation').innerHTML = recHTML;
        }

        // --- Cafe Pricing ---
        function renderCafePricing() {
            const tbody = document.querySelector('#cafe-pricing-table tbody');
            if (!tbody) return;

            const rows = purchasedBeans.map(bean => {
                const priceJPY = bean.priceJPY || 0;

                // Smart weight parsing
                // "100g" ‚Üí 100, "200g" ‚Üí 200, "60g" ‚Üí 60
                // "4oz (114g)" ‚Üí 114 (prefer grams in parentheses)
                // "4x15g" ‚Üí 60 (multiply: 4 √ó 15)
                function parseWeightG(w) {
                    if (!w) return 200;
                    const ozWithG = w.match(/\((\d+)g\)/);
                    if (ozWithG) return parseInt(ozWithG[1]);
                    const multi = w.match(/(\d+)\s*x\s*(\d+)\s*g/i);
                    if (multi) return parseInt(multi[1]) * parseInt(multi[2]);
                    const oz = w.match(/(\d+(?:\.\d+)?)\s*oz/i);
                    if (oz) return Math.round(parseFloat(oz[1]) * 28.35);
                    const kg = w.match(/(\d+(?:\.\d+)?)\s*kg/i);
                    if (kg) return Math.round(parseFloat(kg[1]) * 1000);
                    const g = w.match(/(\d+)\s*g/i);
                    if (g) return parseInt(g[1]);
                    const fallback = w.match(/(\d+)/);
                    return fallback ? parseInt(fallback[1]) : 200;
                }
                const weightG = parseWeightG(bean.weight);

                // Cost per cup = bag price √∑ cups per bag
                // cups per bag = totalWeight √∑ gramsPerCup
                // Ex: 100g bag ¬•10,000, 10g/cup ‚Üí 100√∑10=10cups ‚Üí ¬•10,000√∑10=¬•1,000/cup
                const costPer10g = Math.round(priceJPY / (weightG / 10));
                const costPer15g = Math.round(priceJPY / (weightG / 15));

                // Rarity scoring
                let rarityScore = 0;
                let rarityLabel, rarityClass;
                const variety = (bean.variety || '').toLowerCase();
                const process = (bean.process || '').toLowerCase();
                const pricePerG = priceJPY / weightG;

                // Variety rarity
                if (variety.includes('geisha') || variety.includes('gesha')) rarityScore += 4;
                else if (variety.includes('sl28') || variety.includes('sl34') || variety.includes('pacamara')) rarityScore += 3;
                else if (variety.includes('bourbon') || variety.includes('sidra')) rarityScore += 2;
                else rarityScore += 1;

                // Process rarity
                if (process.includes('anaerobic') || process.includes('thermal shock') || process.includes('lactic') || process.includes('champagne') || process.includes('sangria')) rarityScore += 3;
                else if (process.includes('honey') || process.includes('natural')) rarityScore += 2;
                else rarityScore += 1;

                // Price-based rarity (per gram)
                if (pricePerG > 50) rarityScore += 4;
                else if (pricePerG > 30) rarityScore += 3;
                else if (pricePerG > 15) rarityScore += 2;
                else rarityScore += 1;

                if (rarityScore >= 9) { rarityLabel = 'Legendary'; rarityClass = 'rarity-legendary'; }
                else if (rarityScore >= 7) { rarityLabel = 'Rare'; rarityClass = 'rarity-rare'; }
                else if (rarityScore >= 5) { rarityLabel = 'Uncommon'; rarityClass = 'rarity-uncommon'; }
                else { rarityLabel = 'Common'; rarityClass = 'rarity-common'; }

                // Suggested cafe price: target gross margin by rarity
                // Cap at ¬•8,000 per cup ‚Äî high-end beans accept lower margins
                const MAX_SELL_PRICE = 8000;
                let targetCostRatio;
                if (rarityScore >= 9) targetCostRatio = 0.15;      // Legendary ~85%
                else if (rarityScore >= 7) targetCostRatio = 0.20;  // Rare ~80%
                else if (rarityScore >= 5) targetCostRatio = 0.25;  // Uncommon ~75%
                else targetCostRatio = 0.30;                        // Common ~70%

                let sellPrice10g = Math.ceil(costPer10g / targetCostRatio / 50) * 50;
                let sellPrice15g = Math.ceil(costPer15g / targetCostRatio / 50) * 50;

                // Apply price cap
                if (sellPrice10g > MAX_SELL_PRICE) sellPrice10g = MAX_SELL_PRICE;
                if (sellPrice15g > MAX_SELL_PRICE) sellPrice15g = MAX_SELL_PRICE;

                // Recalculate actual gross margin after cap
                const grossMargin = ((1 - costPer15g / sellPrice15g) * 100).toFixed(1);

                // Gross margin color ‚Äî adjusted thresholds for capped pricing
                let marginColor;
                if (grossMargin >= 70) marginColor = '#059669';
                else if (grossMargin >= 50) marginColor = '#fbbf24';
                else marginColor = '#ff6b6b';

                return {
                    name: bean.name,
                    roaster: bean.roaster,
                    bagPrice: priceJPY,
                    weight: bean.weight || weightG + 'g',
                    costPer10g,
                    costPer15g,
                    rarityLabel,
                    rarityClass,
                    sellPrice10g,
                    sellPrice15g,
                    grossMargin,
                    marginColor,
                    rarityScore
                };
            });

            // Store for sorting
            window._cafePricingRows = rows;
            window._cafePricingSortKey = window._cafePricingSortKey || 'rarityScore';
            window._cafePricingSortDir = window._cafePricingSortDir || 'desc';

            renderCafePricingRows();

            // Attach sort handlers (only once)
            if (!window._cafeSortBound) {
                window._cafeSortBound = true;
                document.querySelectorAll('#cafe-pricing-table .sortable-th').forEach(th => {
                    th.addEventListener('click', () => {
                        const key = th.dataset.sort;
                        if (window._cafePricingSortKey === key) {
                            window._cafePricingSortDir = window._cafePricingSortDir === 'asc' ? 'desc' : 'asc';
                        } else {
                            window._cafePricingSortKey = key;
                            // Text fields default asc, numbers default desc
                            window._cafePricingSortDir = (key === 'name' || key === 'roaster') ? 'asc' : 'desc';
                        }
                        // Update header UI
                        document.querySelectorAll('#cafe-pricing-table .sortable-th').forEach(h => {
                            h.classList.remove('sort-active', 'sort-asc', 'sort-desc');
                        });
                        th.classList.add('sort-active', 'sort-' + window._cafePricingSortDir);
                        renderCafePricingRows();
                    });
                });
                // Set initial active header
                const initTh = document.querySelector('#cafe-pricing-table .sortable-th[data-sort="rarityScore"]');
                if (initTh) initTh.classList.add('sort-active', 'sort-desc');
            }
        }

        function renderCafePricingRows() {
            const tbody = document.querySelector('#cafe-pricing-table tbody');
            if (!tbody || !window._cafePricingRows) return;

            const rows = [...window._cafePricingRows];
            const key = window._cafePricingSortKey;
            const dir = window._cafePricingSortDir === 'asc' ? 1 : -1;

            rows.sort((a, b) => {
                const va = a[key], vb = b[key];
                if (typeof va === 'string') return dir * va.localeCompare(vb);
                return dir * ((parseFloat(va) || 0) - (parseFloat(vb) || 0));
            });

            tbody.innerHTML = rows.map(r => `
                <tr>
                    <td style="font-weight:500; white-space:normal; min-width:180px;">${r.name}</td>
                    <td style="color:#666; white-space:nowrap;">${r.roaster}</td>
                    <td style="white-space:nowrap; background:rgba(255,107,107,0.03);">¬•${r.bagPrice.toLocaleString()} <span style="font-size:10px;color:#999;">(${r.weight})</span></td>
                    <td style="white-space:nowrap; background:rgba(255,107,107,0.03); color:#c0392b;">¬•${r.costPer10g.toLocaleString()}</td>
                    <td style="white-space:nowrap; background:rgba(255,107,107,0.03); color:#c0392b;">¬•${r.costPer15g.toLocaleString()}</td>
                    <td><span class="rarity-badge ${r.rarityClass}">${r.rarityLabel}</span></td>
                    <td style="font-weight:600; white-space:nowrap; background:rgba(36,54,104,0.03); color:var(--color-navy);">¬•${r.sellPrice10g.toLocaleString()}</td>
                    <td style="font-weight:700; white-space:nowrap; background:rgba(36,54,104,0.03); color:var(--color-navy);">¬•${r.sellPrice15g.toLocaleString()}</td>
                    <td>
                        <span class="cost-ratio-bar" style="width:${Math.min(parseFloat(r.grossMargin), 60)}px; background:${r.marginColor};"></span>
                        ${r.grossMargin}%
                    </td>
                </tr>
            `).join('');
        }

        // ===== EVENT HANDLERS =====
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', (e) => {
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));

                button.classList.add('active');
                currentTab = button.dataset.tab;
                document.getElementById('content-' + currentTab).classList.remove('hidden');

                // Save tab state to URL hash
                history.replaceState(null, '', '#' + currentTab);

                // Toggle toolbar/stats visibility for analytics
                const toolbar = document.querySelector('.toolbar');
                const statsBar = document.querySelector('.stats-bar');
                if (currentTab === 'analytics') {
                    if (toolbar) toolbar.style.display = 'none';
                    if (statsBar) statsBar.style.display = 'none';
                    renderAnalytics();
                } else {
                    if (toolbar) toolbar.style.display = '';
                    if (statsBar) statsBar.style.display = '';
                    render();
                }
            });
        });

        // Restore tab from URL hash on load
        (function restoreTab() {
            const hash = location.hash.replace('#', '');
            if (hash && document.getElementById('content-' + hash)) {
                const btn = document.querySelector(`.tab-button[data-tab="${hash}"]`);
                if (btn) btn.click();
            }
        })();

        document.getElementById('view-card').addEventListener('click', () => {
            document.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('view-card').classList.add('active');
            currentView = 'card';
            render();
        });

        document.getElementById('view-table').addEventListener('click', () => {
            document.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('view-table').classList.add('active');
            currentView = 'table';
            render();
        });

        document.getElementById('search-input').addEventListener('input', render);
        document.getElementById('filter-origin').addEventListener('change', render);
        document.getElementById('filter-process').addEventListener('change', render);
        document.getElementById('sort-by').addEventListener('change', render);

        // ===== MODAL FUNCTIONS =====
        function openAddModal() {
            editingBeanId = null;
            editingTab = currentTab;
            document.getElementById('modal-title').textContent = 'Ë±Ü„ÇíËøΩÂä†';
            document.getElementById('modal-delete').classList.add('hidden');
            document.getElementById('bean-form').reset();

            if (currentTab === 'purchased') {
                document.getElementById('character-fields').classList.remove('hidden');
                document.getElementById('considering-fields').classList.add('hidden');
            } else {
                document.getElementById('character-fields').classList.add('hidden');
                document.getElementById('considering-fields').classList.remove('hidden');
            }

            document.getElementById('bean-modal').classList.add('active');
        }

        function openEditModal(id, tab) {
            editingBeanId = id;
            editingTab = tab;
            const beans = tab === 'purchased' ? purchasedBeans : consideringBeans;
            const bean = beans.find(b => b.id === id);

            document.getElementById('modal-title').textContent = 'Ë±Ü„ÇíÁ∑®ÈõÜ';
            document.getElementById('modal-delete').classList.remove('hidden');

            document.getElementById('form-name').value = bean.name;
            document.getElementById('form-roaster').value = bean.roaster;
            document.getElementById('form-origin').value = bean.origin;
            document.getElementById('form-region').value = bean.region || '';
            document.getElementById('form-farm').value = bean.farm || '';
            document.getElementById('form-variety').value = bean.variety || '';
            document.getElementById('form-process').value = bean.process || '';
            document.getElementById('form-elevation').value = bean.elevation || '';
            document.getElementById('form-price').value = bean.price;
            document.getElementById('form-weight').value = bean.weight || '';
            document.getElementById('form-producer').value = bean.producer || '';
            document.getElementById('form-flavor').value = bean.flavor || '';
            document.getElementById('form-url').value = bean.url || '';

            if (tab === 'purchased') {
                document.getElementById('character-fields').classList.remove('hidden');
                document.getElementById('considering-fields').classList.add('hidden');
                document.getElementById('form-character-name').value = bean.characterName || '';
                selectedColors = bean.colorPalette || [];
                document.getElementById('form-story').value = bean.story || '';
                updateColorSelection();
            } else {
                document.getElementById('character-fields').classList.add('hidden');
                document.getElementById('considering-fields').classList.remove('hidden');
                document.getElementById('form-priority').value = bean.priority || 'normal';
                document.getElementById('form-notes').value = bean.notes || '';
            }

            document.getElementById('bean-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('bean-modal').classList.remove('active');
            editingBeanId = null;
            editingTab = null;
            selectedColors = [];
        }

        function openCharacterModal(id) {
            const bean = purchasedBeans.find(b => b.id === id);
            document.getElementById('char-bean-name').value = bean.name;
            document.getElementById('char-name').value = bean.characterName || '';
            document.getElementById('char-story').value = bean.story || '';
            selectedColors = bean.colorPalette || [];
            updateCharacterColorSelection();
            document.getElementById('character-modal').classList.add('active');
        }

        function closeCharacterModal() {
            document.getElementById('character-modal').classList.remove('active');
            selectedColors = [];
        }

        document.getElementById('modal-close').addEventListener('click', closeModal);
        document.getElementById('modal-cancel').addEventListener('click', closeModal);
        document.getElementById('character-modal-close').addEventListener('click', closeCharacterModal);
        document.getElementById('character-modal-cancel').addEventListener('click', closeCharacterModal);

        document.getElementById('modal-delete').addEventListener('click', () => {
            if (confirm('„Åì„ÅÆË±Ü„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                deleteBean(editingBeanId, editingTab);
                closeModal();
            }
        });

        // ===== COLOR PICKER =====
        function updateColorSelection() {
            document.querySelectorAll('#color-palette .color-swatch').forEach(swatch => {
                swatch.classList.remove('selected');
                if (selectedColors.includes(swatch.dataset.color)) {
                    swatch.classList.add('selected');
                }
            });
        }

        function updateCharacterColorSelection() {
            document.querySelectorAll('#char-color-palette .color-swatch').forEach(swatch => {
                swatch.classList.remove('selected');
                if (selectedColors.includes(swatch.dataset.color)) {
                    swatch.classList.add('selected');
                }
            });
        }

        document.querySelectorAll('#color-palette .color-swatch').forEach(swatch => {
            swatch.addEventListener('click', () => {
                const color = swatch.dataset.color;
                if (selectedColors.includes(color)) {
                    selectedColors = selectedColors.filter(c => c !== color);
                } else if (selectedColors.length < 5) {
                    selectedColors.push(color);
                }
                updateColorSelection();
            });
        });

        document.querySelectorAll('#char-color-palette .color-swatch').forEach(swatch => {
            swatch.addEventListener('click', () => {
                const color = swatch.dataset.color;
                if (selectedColors.includes(color)) {
                    selectedColors = selectedColors.filter(c => c !== color);
                } else if (selectedColors.length < 5) {
                    selectedColors.push(color);
                }
                updateCharacterColorSelection();
            });
        });

        // ===== FORM SUBMISSION =====
        document.getElementById('bean-form').addEventListener('submit', (e) => {
            e.preventDefault();

            const beanData = {
                id: editingBeanId || nextId++,
                name: document.getElementById('form-name').value,
                roaster: document.getElementById('form-roaster').value,
                origin: document.getElementById('form-origin').value,
                region: document.getElementById('form-region').value,
                farm: document.getElementById('form-farm').value,
                variety: document.getElementById('form-variety').value,
                process: document.getElementById('form-process').value,
                elevation: document.getElementById('form-elevation').value,
                price: document.getElementById('form-price').value,
                weight: document.getElementById('form-weight').value,
                producer: document.getElementById('form-producer').value,
                flavor: document.getElementById('form-flavor').value,
                url: document.getElementById('form-url').value
            };

            if (editingTab === 'purchased') {
                beanData.characterName = document.getElementById('form-character-name').value;
                beanData.colorPalette = selectedColors;
                beanData.story = document.getElementById('form-story').value;
            } else {
                beanData.priority = document.getElementById('form-priority').value;
                beanData.notes = document.getElementById('form-notes').value;
            }

            const beans = editingTab === 'purchased' ? purchasedBeans : consideringBeans;

            if (editingBeanId) {
                const index = beans.findIndex(b => b.id === editingBeanId);
                beans[index] = { ...beans[index], ...beanData };
            } else {
                beans.push(beanData);
            }

            closeModal();
            render();
        });

        document.getElementById('character-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('char-name').value;
            const story = document.getElementById('char-story').value;

            const charName = document.getElementById('char-bean-name').value;
            const bean = purchasedBeans.find(b => b.name === charName);

            if (bean) {
                bean.characterName = name;
                bean.colorPalette = selectedColors;
                bean.story = story;
            }

            closeCharacterModal();
            render();
        });

        // ===== DELETE BEAN =====
        function deleteBean(id, tab) {
            const beans = tab === 'purchased' ? purchasedBeans : consideringBeans;
            const index = beans.findIndex(b => b.id === id);
            if (index > -1) {
                beans.splice(index, 1);
                render();
            }
        }

        // ===== ROASTER GROUP TOGGLE =====
        function toggleRoasterGroup(header) {
            const content = header.nextElementSibling;
            const toggle = header.querySelector('.roaster-toggle');
            content.classList.toggle('collapsed');
            toggle.classList.toggle('collapsed');
        }

        // ===== IMPORT URL =====
        document.getElementById('btn-import-url').addEventListener('click', () => {
            document.getElementById('import-panel').classList.toggle('active');
        });

        document.getElementById('btn-import-cancel').addEventListener('click', () => {
            document.getElementById('import-panel').classList.remove('active');
            document.getElementById('import-url-input').value = '';
        });

        document.getElementById('btn-import-submit').addEventListener('click', () => {
            const url = document.getElementById('import-url-input').value.trim();
            if (url) {
                const newBean = {
                    id: null,
                    name: 'New Bean',
                    roaster: '',
                    origin: '',
                    region: '',
                    farm: '',
                    variety: '',
                    process: '',
                    elevation: '',
                    price: '',
                    weight: '',
                    producer: '',
                    flavor: '',
                    url: url,
                    priority: 'normal',
                    notes: ''
                };

                if (currentTab === 'considering') {
                    consideringBeans.push({...newBean, id: nextId++, priority: 'normal', notes: ''});
                } else {
                    purchasedBeans.push({...newBean, id: nextId++, characterName: '', colorPalette: [], story: ''});
                }

                document.getElementById('import-panel').classList.remove('active');
                document.getElementById('import-url-input').value = '';
                render();
            }
        });

        // ===== ADD BEAN BUTTON =====
        document.getElementById('btn-add-bean').addEventListener('click', openAddModal);

        // ===== EXPORT CSV =====
        document.getElementById('btn-export-csv').addEventListener('click', () => {
            const beans = currentTab === 'purchased' ? purchasedBeans : consideringBeans;
            const filtered = filterAndSortBeans(beans);

            if (filtered.length === 0) {
                alert('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }

            const headers = ['ÂêçÂâç', '„É≠„Éº„Çπ„Çø„Éº', 'Âá∫Ë∫´ÂõΩ', '„Éó„É≠„Çª„Çπ', '‰æ°Ê†º', 'ÈáçÈáè', 'URL'];
            const rows = filtered.map(bean => [
                bean.name,
                bean.roaster,
                bean.origin,
                bean.process,
                bean.price,
                bean.weight,
                bean.url
            ]);

            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell.replace(/"/g, '""')}"`).join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `beans-${currentTab}-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // Initial render
        render();
    </script>
</body>
</html>
